<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransForward Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #ffffff;
            --secondary: #34495e;
            --accent: #e74c3c;
            --primary-text: #2c3e50;
            --secondary-text: #ecf0f1;
            --light-gray: #ecf0f1;
            --dark-gray: #34495e;
            --border-color: #bdc3c7;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary);
            color: var(--primary-text);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--dark-gray);
            color: var(--secondary-text);
            padding: 20px 0;
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h3 {
            color: var(--secondary-text);
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(255,255,255,0.1);
            border-left: 4px solid var(--accent);
        }

        .nav-item i {
            margin-right: 10px;
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 20px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px 20px;
            background-color: var(--secondary);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-body {
            padding: 20px;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--accent);
            color: var(--accent);
            font-weight: 600;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }

        .status-pending {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .status-inactive {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        .status-completed {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--info);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px 20px;
            background-color: var(--secondary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h5 {
            font-weight: 600;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-desc {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Chat */
        .chat-container {
            display: flex;
            height: 500px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-sidebar {
            width: 250px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .chat-user {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .chat-user:hover {
            background-color: #f8f9fa;
        }

        .chat-user.active {
            background-color: #e8f4fd;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .message.own {
            margin-left: auto;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            display: inline-block;
        }

        .message.own .message-content {
            background-color: var(--accent);
            color: white;
        }

        .message.other .message-content {
            background-color: white;
            border: 1px solid var(--border-color);
        }

        .message-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 10px 0;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Drag and drop */
        .draggable {
            cursor: move;
            padding: 8px;
            margin: 4px 0;
            border: 1px dashed #bdc3c7;
            border-radius: 4px;
        }

        .draggable:hover {
            border-color: var(--accent);
        }

        .dropzone {
            min-height: 100px;
            border: 2px dashed #bdc3c7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .dropzone.highlight {
            border-color: var(--accent);
            background-color: rgba(231, 76, 60, 0.05);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }

        /* Login/Register */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: var(--secondary);
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide elements initially */
        .hidden {
            display: none;
        }

        /* Dashboard view */
        .dashboard-view {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
        }

        @media (max-width: 992px) {
            .dashboard-view {
                grid-template-columns: 1fr;
            }
        }

        /* Profile view */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .profile-sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-main {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--accent);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
        }

        .profile-info {
            margin-bottom: 20px;
        }

        .profile-info h3 {
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        /* Notification panel */
        .notification-panel {
            position: absolute;
            top: 50px;
            right: 20px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .notification-panel.show {
            display: block;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #f8f9fa;
            font-weight: 500;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-time {
            font-size: 12px;
            color: #7f8c8d;
        }

        /* File upload */
        .file-upload {
            border: 2px dashed #bdc3c7;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-upload:hover {
            border-color: var(--accent);
        }

        .file-upload i {
            font-size: 40px;
            color: #bdc3c7;
            margin-bottom: 10px;
        }

        /* Tree view */
        .tree {
            list-style: none;
            padding-left: 20px;
        }

        .tree li {
            margin: 10px 0;
            position: relative;
        }

        .tree li::before {
            content: "";
            position: absolute;
            left: -15px;
            top: 10px;
            width: 10px;
            height: 1px;
            background-color: #bdc3c7;
        }

        .tree li::after {
            content: "";
            position: absolute;
            left: -10px;
            top: 0;
            width: 1px;
            height: 100%;
            background-color: #bdc3c7;
        }

        .tree li:last-child::after {
            height: 10px;
        }

        /* Status hierarchy */
        .status-hierarchy {
            padding-left: 20px;
            margin-top: 10px;
        }

        .status-hierarchy-item {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-hierarchy-item .status-badge {
            padding: 3px 6px;
            font-size: 11px;
        }

        .status-hierarchy-item .actions {
            margin-left: auto;
            display: none;
        }

        .status-hierarchy-item:hover .actions {
            display: flex;
        }

        .status-hierarchy-item .actions button {
            padding: 2px 5px;
            margin-left: 5px;
            font-size: 12px;
        }

        .status-hierarchy-item.dragging {
            opacity: 0.5;
        }

        .status-hierarchy-item.placeholder {
            height: 30px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 4px;
            margin: 5px 0;
        }

        /* Car type dimensions */
        .car-type-dimensions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .car-type-dimensions {
                grid-template-columns: 1fr;
            }
        }

        .car-type-dimensions .form-group {
            margin-bottom: 0;
        }

        /* Status selector */
        .status-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .status-selector {
                grid-template-columns: 1fr;
            }
        }

        /* Cubic capacity display */
        .cubic-display {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .cubic-breakdown {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 8px;
        }

        .cubic-row {
            display: flex;
            justify-content: space-between;
        }

        .cubic-label {
            font-weight: 500;
        }

        .trailer-dimensions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        /* Car details display */
        .car-details {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .car-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .car-detail-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .car-detail-value {
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- Auth Views -->
    <div id="auth-container" class="auth-container">
        <div class="auth-header">
            <h2>TransForward Manager</h2>
            <p>Transport and Forwarding Management System</p>
        </div>
        
        <div id="login-form">
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" class="form-control" id="login-email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" class="form-control" id="login-password" required>
            </div>
            <div class="form-group">
                <label for="login-token">GitHub Token</label>
                <input type="password" class="form-control" id="login-token" required>
            </div>
            <div class="form-group">
                <label for="login-repo">Repository Name</label>
                <input type="text" class="form-control" id="login-repo" required>
            </div>
            <button class="btn btn-primary" id="login-btn">Login</button>
            <div class="form-actions">
                <a href="#" id="show-register">Create an account</a>
            </div>
        </div>

        <div id="register-form" class="hidden">
            <div class="form-group">
                <label for="register-email">Email</label>
                <input type="email" class="form-control" id="register-email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Password</label>
                <input type="password" class="form-control" id="register-password" required>
            </div>
            <div class="form-group">
                <label for="register-token">GitHub Token</label>
                <input type="password" class="form-control" id="register-token" required>
            </div>
            <div class="form-group">
                <label for="register-repo">Repository Name</label>
                <input type="text" class="form-control" id="register-repo" required>
            </div>
            <button class="btn btn-primary" id="register-btn">Register</button>
            <div class="form-actions">
                <a href="#" id="show-login">Already have an account?</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>TransForward</h3>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-view="dashboard">
                    <i>📊</i> Dashboard
                </li>
                <li class="nav-item" data-view="drivers">
                    <i>🚚</i> Drivers
                </li>
                <li class="nav-item" data-view="cars">
                    <i>🚛</i> Cars
                </li>
                <li class="nav-item" data-view="cards">
                    <i>💳</i> Cards
                </li>
                <li class="nav-item" data-view="tenders">
                    <i>📋</i> Tenders
                </li>
                <li class="nav-item" data-view="invoices">
                    <i>🧾</i> Invoices
                </li>
                <li class="nav-item" data-view="reports">
                    <i>📈</i> Reports
                </li>
                <li class="nav-item" data-view="admin" id="admin-menu" style="display: none;">
                    <i>👨‍💼</i> Administration
                </li>
                <li class="nav-item" data-view="chat">
                    <i>💬</i> Chat
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="user-name">User</span>
                    <div class="notification-icon" id="notification-icon">
                        <i>🔔</i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </div>
                    <i class="dropdown-toggle" id="user-menu-toggle">▼</i>
                </div>
            </div>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu" id="user-dropdown">
                <div class="dropdown-item" id="logout-btn">Logout</div>
            </div>

            <!-- Notification Panel -->
            <div class="notification-panel" id="notification-panel">
                <div class="notification-item">
                    <div class="notification-title">System Update</div>
                    <div class="notification-message">New version available</div>
                    <div class="notification-time">2 minutes ago</div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view">
                <div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Active Drivers</h3>
                            <div class="stat-value" id="active-drivers">0</div>
                            <div class="stat-desc">Currently on route</div>
                        </div>
                        <div class="stat-card">
                            <h3>Active Tenders</h3>
                            <div class="stat-value" id="active-tenders">0</div>
                            <div class="stat-desc">In progress</div>
                        </div>
                        <div class="stat-card">
                            <h3>Revenue This Month</h3>
                            <div class="stat-value" id="monthly-revenue">$0</div>
                            <div class="stat-desc">Total earnings</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Invoices</h3>
                            <div class="stat-value" id="pending-invoices">0</div>
                            <div class="stat-desc">Awaiting payment</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Recent Activity</div>
                        <div class="card-body">
                            <ul id="recent-activity" class="list-unstyled">
                                <li class="mb-2">System initialized</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <div class="card-header">Upcoming Expirations</div>
                        <div class="card-body">
                            <ul id="expirations-list" class="list-unstyled">
                                <li>No upcoming expirations</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Quick Actions</div>
                        <div class="card-body">
                            <button class="btn btn-primary mb-2" id="quick-add-driver">Add Driver</button>
                            <button class="btn btn-primary mb-2" id="quick-add-tender">Add Tender</button>
                            <button class="btn btn-primary" id="quick-add-invoice">Add Invoice</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drivers View -->
            <div id="drivers-view" class="hidden">
                <div class="card">
                    <div class="card-header">
                        Drivers Management
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Car</th>
                                        <th>Card</th>
                                        <th>Status</th>
                                        <th>Sub-Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="drivers-table-body">
                                    <!-- Drivers will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cars View -->
            <div id="cars-view" class="hidden">
                <div class="card">
                    <div class="card-header">
                        Cars Management
                        <button class="btn btn-primary" id="add-car-btn">Add Car</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tractor Plate</th>
                                        <th>Trailer Plate</th>
                                        <th>Type</th>
                                        <th>Capacity</th>
                                        <th>Max Weight</th>
                                        <th>Insurance</th>
                                        <th>Inspection</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cars-table-body">
                                    <!-- Cars will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cards View -->
            <div id="cards-view" class="hidden">
                <div class="card">
                    <div class="card-header">
                        Cards Management
                        <button class="btn btn-primary" id="add-card-btn">Add Card</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Card Number</th>
                                        <th>PIN</th>
                                        <th>Expiry</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cards-table-body">
                                    <!-- Cards will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">Assign Cards to Cars/Drivers</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Available Cards</h5>
                                        <div class="dropzone" id="available-cards">
                                            <p>Drag cards here</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Assigned Cards</h5>
                                        <div class="dropzone" id="assigned-cards">
                                            <p>Cards will appear here when assigned</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenders View -->
            <div id="tenders-view" class="hidden">
                <div class="card">
                    <div class="card-header">
                        Tenders Management
                        <button class="btn btn-primary" id="add-tender-btn">Add Tender</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Loading</th>
                                        <th>Unloading</th>
                                        <th>Price</th>
                                        <th>Driver</th>
                                        <th>Status</th>
                                        <th>Sub-Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tenders-table-body">
                                    <!-- Tenders will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoices View -->
            <div id="invoices-view" class="hidden">
                <div class="card">
                    <div class="card-header">
                        Invoices Management
                        <button class="btn btn-primary" id="add-invoice-btn">Add Invoice</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Due</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoices-table-body">
                                    <!-- Invoices will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports-view" class="hidden">
                <div class="card">
                    <div class="card-header">Performance Reports</div>
                    <div class="card-body">
                        <div class="tabs">
                            <div class="tab active" data-tab="weekly">Weekly</div>
                            <div class="tab" data-tab="monthly">Monthly</div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="revenue-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="loading-chart"></canvas>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">Top Drivers</div>
                                    <div class="card-body">
                                        <ul id="top-drivers" class="list-group">
                                            <!-- Top drivers will be listed here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">Revenue Breakdown</div>
                                    <div class="card-body">
                                        <canvas id="revenue-breakdown-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden">
                <div class="tabs">
                    <div class="tab active" data-tab="users">Users</div>
                    <div class="tab" data-tab="statuses">Statuses</div>
                    <div class="tab" data-tab="cartypes">Car Types</div>
                    <div class="tab" data-tab="migration">Migration</div>
                </div>
                
                <!-- Users Tab -->
                <div class="tab-content" id="users-tab">
                    <div class="card">
                        <div class="card-header">
                            User Management
                            <button class="btn btn-primary" id="add-user-btn">Add User</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Supervisor</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- Users will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">Organization Tree</div>
                                <div class="card-body">
                                    <ul class="tree" id="org-tree">
                                        <!-- Organization tree will be built here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statuses Tab -->
                <div class="tab-content hidden" id="statuses-tab">
                    <div class="card">
                        <div class="card-header">
                            Status Management
                            <button class="btn btn-primary" id="add-status-btn">Add Status</button>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="status-type-filter">Filter by Type</label>
                                <select class="form-control" id="status-type-filter">
                                    <option value="all">All Types</option>
                                    <option value="driver">Driver</option>
                                    <option value="car">Car</option>
                                    <option value="card">Card</option>
                                    <option value="tender">Tender</option>
                                    <option value="invoice">Invoice</option>
                                </select>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">Driver Status Hierarchy</div>
                                <div class="card-body">
                                    <div class="status-hierarchy" id="driver-status-hierarchy" data-type="driver">
                                        <!-- Driver statuses will be populated here -->
                                    </div>
                                    <button class="btn btn-primary mt-3" id="add-driver-status-btn">Add Driver Status</button>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header">Car Status Hierarchy</div>
                                <div class="card-body">
                                    <div class="status-hierarchy" id="car-status-hierarchy" data-type="car">
                                        <!-- Car statuses will be populated here -->
                                    </div>
                                    <button class="btn btn-primary mt-3" id="add-car-status-btn">Add Car Status</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Car Types Tab -->
                <div class="tab-content hidden" id="cartypes-tab">
                    <div class="card">
                        <div class="card-header">
                            Car Types Management
                            <button class="btn btn-primary" id="add-cartype-btn">Add Car Type</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Dimensions (LxWxH)</th>
                                            <th>Trailer Dimensions (LxWxH)</th>
                                            <th>Max Weight</th>
                                            <th>Tandem</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cartypes-table-body">
                                        <!-- Car types will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Migration Tab -->
                <div class="tab-content hidden" id="migration-tab">
                    <div class="card">
                        <div class="card-header">Database Migration</div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="migration-token">New GitHub Token</label>
                                <input type="password" class="form-control" id="migration-token">
                            </div>
                            <div class="form-group">
                                <label for="migration-repo">New Repository Name</label>
                                <input type="text" class="form-control" id="migration-repo">
                            </div>
                            <button class="btn btn-primary" id="migrate-btn">Migrate Database</button>
                            <p class="mt-2 text-muted">This will migrate all data to a new repository. Make sure you have the necessary permissions.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chat-view" class="hidden">
                <div class="card">
                    <div class="card-header">Team Chat</div>
                    <div class="card-body">
                        <div class="chat-container">
                            <div class="chat-sidebar">
                                <div class="chat-user active" data-user="all">
                                    <strong>General Chat</strong>
                                </div>
                                <div id="chat-users-list">
                                    <!-- Chat users will be populated here -->
                                </div>
                            </div>
                            <div class="chat-main">
                                <div class="chat-messages" id="chat-messages">
                                    <div class="message other">
                                        <div class="message-content">Welcome to TransForward chat!</div>
                                        <div class="message-meta">System - just now</div>
                                    </div>
                                </div>
                                <div class="chat-input">
                                    <input type="text" id="chat-input" placeholder="Type a message...">
                                    <button class="btn btn-primary" id="chat-send">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Driver Modal -->
    <div class="modal" id="driver-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="driver-modal-title">Add Driver</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="driver-name">First Name</label>
                    <input type="text" class="form-control" id="driver-name" required>
                </div>
                <div class="form-group">
                    <label for="driver-lastname">Last Name</label>
                    <input type="text" class="form-control" id="driver-lastname" required>
                </div>
                <div class="form-group">
                    <label for="driver-car">Assigned Car</label>
                    <select class="form-control" id="driver-car">
                        <option value="">Select Car</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="driver-card">Assigned Card</label>
                    <select class="form-control" id="driver-card">
                        <option value="">Select Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="driver-on-break">On Break</label>
                    <select class="form-control" id="driver-on-break">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="driver-on-vacation">On Vacation</label>
                    <select class="form-control" id="driver-on-vacation">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="driver-work-hours">Work Hours</label>
                    <input type="text" class="form-control" id="driver-work-hours" placeholder="e.g. 8:00-17:00" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="driver-cancel">Cancel</button>
                <button class="btn btn-primary" id="driver-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Car Modal -->
    <div class="modal" id="car-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="car-modal-title">Add Car</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="car-tractor">Tractor Plate Number</label>
                    <input type="text" class="form-control" id="car-tractor" required>
                </div>
                <div class="form-group">
                    <label for="car-trailer">Trailer Plate Number</label>
                    <input type="text" class="form-control" id="car-trailer" required>
                </div>
                <div class="form-group">
                    <label for="car-type">Vehicle Type</label>
                    <select class="form-control" id="car-type">
                        <option value="">Select Type</option>
                    </select>
                </div>
                
                <div id="car-type-details" class="car-details hidden">
                    <div class="car-detail-row">
                        <span class="car-detail-label">Dimensions:</span>
                        <span class="car-detail-value" id="car-type-dimensions">-</span>
                    </div>
                    <div class="car-detail-row">
                        <span class="car-detail-label">Main Vehicle Weight:</span>
                        <span class="car-detail-value" id="car-main-weight">-</span>
                    </div>
                    <div class="car-detail-row" id="trailer-weight-row" style="display: none;">
                        <span class="car-detail-label">Trailer Weight:</span>
                        <span class="car-detail-value" id="car-trailer-weight">-</span>
                    </div>
                    <div class="car-detail-row">
                        <span class="car-detail-label">Total Weight:</span>
                        <span class="car-detail-value" id="car-total-weight">-</span>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="car-insurance">Insurance Expiry</label>
                            <input type="date" class="form-control" id="car-insurance" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="car-inspection">Inspection Expiry</label>
                            <input type="date" class="form-control" id="car-inspection" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="car-insurance-notify">Notify Before (days)</label>
                            <input type="number" class="form-control" id="car-insurance-notify" value="30">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="car-inspection-notify">Notify Before (days)</label>
                            <input type="number" class="form-control" id="car-inspection-notify" value="30">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="car-status">Status</label>
                    <select class="form-control" id="car-status">
                        <!-- Will be populated from statuses -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="car-cancel">Cancel</button>
                <button class="btn btn-primary" id="car-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Card Modal -->
    <div class="modal" id="card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="card-modal-title">Add Card</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="card-number">Card Number</label>
                    <input type="text" class="form-control" id="card-number" required>
                </div>
                <div class="form-group">
                    <label for="card-pin">PIN</label>
                    <input type="password" class="form-control" id="card-pin" required>
                </div>
                <div class="form-group">
                    <label for="card-expiry">Expiry Date</label>
                    <input type="date" class="form-control" id="card-expiry" required>
                </div>
                <div class="form-group">
                    <label for="card-notify">Notify Before (days)</label>
                    <input type="number" class="form-control" id="card-notify" value="30">
                </div>
                <div class="form-group">
                    <label for="card-reminder">Reminder Frequency (days)</label>
                    <input type="number" class="form-control" id="card-reminder" value="7">
                </div>
                <div class="form-group">
                    <label for="card-status">Status</label>
                    <select class="form-control" id="card-status">
                        <!-- Will be populated from statuses -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="card-cancel">Cancel</button>
                <button class="btn btn-primary" id="card-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Tender Modal -->
    <div class="modal" id="tender-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="tender-modal-title">Add Tender</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tender-loading-date">Loading Date</label>
                            <input type="datetime-local" class="form-control" id="tender-loading-date" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tender-unloading-date">Unloading Date</label>
                            <input type="datetime-local" class="form-control" id="tender-unloading-date" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tender-loading-city">Loading City</label>
                            <input type="text" class="form-control" id="tender-loading-city" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tender-loading-zip">Loading ZIP</label>
                            <input type="text" class="form-control" id="tender-loading-zip" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tender-unloading-city">Unloading City</label>
                            <input type="text" class="form-control" id="tender-unloading-city" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tender-unloading-zip">Unloading ZIP</label>
                            <input type="text" class="form-control" id="tender-unloading-zip" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tender-price">Price ($)</label>
                    <input type="number" step="0.01" class="form-control" id="tender-price" required>
                </div>
                <div class="form-group">
                    <label for="tender-driver">Assigned Driver</label>
                    <select class="form-control" id="tender-driver">
                        <option value="">Select Driver</option>
                    </select>
                </div>
                <div class="status-selector">
                    <div class="form-group">
                        <label for="tender-status">Status</label>
                        <select class="form-control" id="tender-status">
                            <!-- Will be populated from driver statuses -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tender-substatus">Sub-Status</label>
                        <select class="form-control" id="tender-substatus">
                            <!-- Will be populated based on selected status -->
                        </select>
                    </div>
                </div>
                <div id="tender-sale-fields" class="hidden">
                    <div class="form-group">
                        <label for="tender-sale-price">Sale Price ($)</label>
                        <input type="number" step="0.01" class="form-control" id="tender-sale-price">
                    </div>
                    <div class="form-group">
                        <label for="tender-payment-days">Payment Terms (days)</label>
                        <input type="number" class="form-control" id="tender-payment-days" value="30">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="tender-cancel">Cancel</button>
                <button class="btn btn-primary" id="tender-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal" id="invoice-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="invoice-modal-title">Add Invoice</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="invoice-code">Invoice Code</label>
                    <input type="text" class="form-control" id="invoice-code" required>
                </div>
                <div class="form-group">
                    <label for="invoice-client">Client Name</label>
                    <input type="text" class="form-control" id="invoice-client" required>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="invoice-date">Issue Date</label>
                            <input type="date" class="form-control" id="invoice-date" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="invoice-due-days">Payment Terms (days)</label>
                            <input type="number" class="form-control" id="invoice-due-days" value="30" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="invoice-notify">Notify Before (days)</label>
                    <input type="number" class="form-control" id="invoice-notify" value="7">
                </div>
                <div class="form-group">
                    <label for="invoice-reminder">Reminder Frequency (days)</label>
                    <input type="number" class="form-control" id="invoice-reminder" value="3">
                </div>
                <div class="form-group">
                    <label for="invoice-status">Status</label>
                    <select class="form-control" id="invoice-status">
                        <!-- Will be populated from statuses -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="invoice-cancel">Cancel</button>
                <button class="btn btn-primary" id="invoice-save">Save</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="user-modal-title">Add User</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="user-name-input">First Name</label>
                    <input type="text" class="form-control" id="user-name-input" required>
                </div>
                <div class="form-group">
                    <label for="user-lastname">Last Name</label>
                    <input type="text" class="form-control" id="user-lastname" required>
                </div>
                <div class="form-group">
                    <label for="user-email">Email</label>
                    <input type="email" class="form-control" id="user-email" required>
                </div>
                <div class="form-group">
                    <label for="user-password">Password</label>
                    <input type="password" class="form-control" id="user-password" required>
                </div>
                <div class="form-group">
                    <label for="user-status">Status</label>
                    <select class="form-control" id="user-status">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="user-supervisor">Supervisor</label>
                    <select class="form-control" id="user-supervisor">
                        <option value="">None</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="user-cancel">Cancel</button>
                <button class="btn btn-primary" id="user-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div class="modal" id="status-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="status-modal-title">Add Status</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="status-name">Status Name</label>
                    <input type="text" class="form-control" id="status-name" required>
                </div>
                <div class="form-group">
                    <label for="status-type">Type</label>
                    <select class="form-control" id="status-type">
                        <option value="driver">Driver</option>
                        <option value="car">Car</option>
                        <option value="card">Card</option>
                        <option value="tender">Tender</option>
                        <option value="invoice">Invoice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-is-primary">Status Level</label>
                    <select class="form-control" id="status-is-primary">
                        <option value="true">Primary Status</option>
                        <option value="false">Sub-Status</option>
                    </select>
                </div>
                <div class="form-group" id="status-parent-container" style="display: none;">
                    <label for="status-parent">Parent Status</label>
                    <select class="form-control" id="status-parent">
                        <!-- Will be populated based on type -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-color">Color</label>
                    <select class="form-control" id="status-color">
                        <option value="active">Green (Active)</option>
                        <option value="pending">Yellow (Pending)</option>
                        <option value="inactive">Red (Inactive)</option>
                        <option value="completed">Blue (Completed)</option>
                        <option value="warning">Orange (Warning)</option>
                        <option value="danger">Dark Red (Danger)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="status-cancel">Cancel</button>
                <button class="btn btn-primary" id="status-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Car Type Modal -->
    <div class="modal" id="cartype-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="cartype-modal-title">Add Vehicle Type</h5>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="cartype-name">Name</label>
                    <input type="text" class="form-control" id="cartype-name" required>
                </div>
                <div class="form-group">
                    <label for="cartype-description">Description</label>
                    <textarea class="form-control" id="cartype-description" rows="3"></textarea>
                </div>
                <div class="car-type-dimensions">
                    <div class="form-group">
                        <label for="cartype-length">Main Vehicle Length (m)</label>
                        <input type="number" step="0.1" class="form-control" id="cartype-length" required>
                    </div>
                    <div class="form-group">
                        <label for="cartype-width">Main Vehicle Width (m)</label>
                        <input type="number" step="0.1" class="form-control" id="cartype-width" required>
                    </div>
                    <div class="form-group">
                        <label for="cartype-height">Main Vehicle Height (m)</label>
                        <input type="number" step="0.1" class="form-control" id="cartype-height" required>
                    </div>
                    <div class="form-group">
                        <label for="cartype-main-weight">Main Vehicle Max Weight (tons)</label>
                        <input type="number" step="0.1" class="form-control" id="cartype-main-weight" required>
                    </div>
                    
                    <div class="form-group mt-3">
                        <label for="cartype-is-tandem">Tandem Configuration</label>
                        <select class="form-control" id="cartype-is-tandem">
                            <option value="false">No (Standard)</option>
                            <option value="true">Yes (Tandem)</option>
                        </select>
                    </div>
                    
                    <div class="trailer-dimensions hidden" id="trailer-dimensions">
                        <h5 class="mt-3">Trailer Dimensions</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="cartype-trailer-length">Trailer Length (m)</label>
                                    <input type="number" step="0.1" class="form-control" id="cartype-trailer-length" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="cartype-trailer-width">Trailer Width (m)</label>
                                    <input type="number" step="0.1" class="form-control" id="cartype-trailer-width" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="cartype-trailer-height">Trailer Height (m)</label>
                                    <input type="number" step="0.1" class="form-control" id="cartype-trailer-height" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="cartype-trailer-weight">Trailer Max Weight (tons)</label>
                            <input type="number" step="0.1" class="form-control" id="cartype-trailer-weight" required>
                        </div>
                    </div>
                    
                    <div class="cubic-display">
                        <h5>Cubic Capacity Calculation</h5>
                        <div class="cubic-breakdown">
                            <div class="cubic-row">
                                <span class="cubic-label">Main Vehicle:</span>
                                <span id="cartype-main-cubic">0.00 m³</span>
                            </div>
                            <div class="cubic-row" id="trailer-cubic-row" style="display: none;">
                                <span class="cubic-label">Trailer:</span>
                                <span id="cartype-trailer-cubic">0.00 m³</span>
                            </div>
                            <div class="cubic-row">
                                <span class="cubic-label">Total:</span>
                                <span id="cartype-total-cubic">0.00 m³</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cubic-display mt-3">
                        <h5>Weight Capacity</h5>
                        <div class="cubic-breakdown">
                            <div class="cubic-row">
                                <span class="cubic-label">Main Vehicle:</span>
                                <span id="cartype-main-weight-display">0.0 tons</span>
                            </div>
                            <div class="cubic-row" id="trailer-weight-row" style="display: none;">
                                <span class="cubic-label">Trailer:</span>
                                <span id="cartype-trailer-weight-display">0.0 tons</span>
                            </div>
                            <div class="cubic-row">
                                <span class="cubic-label">Total:</span>
                                <span id="cartype-total-weight-display">0.0 tons</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cartype-cancel">Cancel</button>
                <button class="btn btn-primary" id="cartype-save">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Proper UTF-8 encoding/decoding functions
        function utf8ToBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function base64ToUtf8(base64) {
            return decodeURIComponent(escape(atob(base64)));
        }

        // App state
        const state = {
            currentUser: null,
            githubToken: '',
            repoName: '',
            currentView: 'dashboard',
            notifications: [],
            unreadNotifications: 0,
            // Data stores with SHA
            drivers: { data: [], sha: null },
            cars: { data: { data: [], carTypes: [] }, sha: null },
            cards: { data: [], sha: null },
            tenders: { data: [], sha: null },
            invoices: { data: [], sha: null },
            users: { data: [], sha: null },
            statuses: { data: [], sha: null },
            chat: { data: [], sha: null }
        };

        // GitHub file paths
        const FILE_PATHS = {
            DRIVERS: 'data/drivers.json',
            CARS: 'data/cars.json',  // Now contains both cars and car types
            CARDS: 'data/cards.json',
            TENDERS: 'data/tenders.json',
            INVOICES: 'data/invoices.json',
            USERS: 'data/users.json',
            STATUSES: 'data/statuses.json',
            CHAT: 'data/chat.json'
        };

        // Status types
        const STATUS_TYPES = {
            DRIVER: 'driver',
            CAR: 'car',
            CARD: 'card',
            TENDER: 'tender',
            INVOICE: 'invoice'
        };

        // Status colors
        const STATUS_COLORS = {
            active: 'status-active',
            pending: 'status-pending',
            inactive: 'status-inactive',
            completed: 'status-completed',
            warning: 'status-pending',
            danger: 'status-inactive'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('transforward_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    state.currentUser = user;
                    state.githubToken = user.token;
                    state.repoName = user.repo;
                    showApp();
                } catch (e) {
                    console.log('No saved user found');
                }
            }

            // Setup event listeners - only if elements exist
            setupEventListeners();
            setupDragAndDrop();
        });

        // Setup all event listeners with null checks
        function setupEventListeners() {
            // Auth - Fixed the event listeners for show/hide with null checks
            const showRegisterBtn = document.getElementById('show-register');
            if (showRegisterBtn) {
                showRegisterBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('register-form').classList.remove('hidden');
                });
            }
            
            const showLoginBtn = document.getElementById('show-login');
            if (showLoginBtn) {
                showLoginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    document.getElementById('register-form').classList.add('hidden');
                    document.getElementById('login-form').classList.remove('hidden');
                });
            }

            // Auth buttons with null checks
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
            
            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) {
                registerBtn.addEventListener('click', handleRegister);
            }
            
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            // Navigation - only if nav items exist
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    navigateTo(view);
                });
            });

            // User menu with null checks
            const userMenuToggle = document.getElementById('user-menu-toggle');
            if (userMenuToggle) {
                userMenuToggle.addEventListener('click', toggleUserDropdown);
            }
            
            const notificationIcon = document.getElementById('notification-icon');
            if (notificationIcon) {
                notificationIcon.addEventListener('click', toggleNotificationPanel);
            }

            // Quick actions with null checks
            const quickAddDriver = document.getElementById('quick-add-driver');
            if (quickAddDriver) {
                quickAddDriver.addEventListener('click', () => openModal('driver'));
            }
            
            const quickAddTender = document.getElementById('quick-add-tender');
            if (quickAddTender) {
                quickAddTender.addEventListener('click', () => openModal('tender'));
            }
            
            const quickAddInvoice = document.getElementById('quick-add-invoice');
            if (quickAddInvoice) {
                quickAddInvoice.addEventListener('click', () => openModal('invoice'));
            }

            // Modals
            document.querySelectorAll('.close').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            // Modal save buttons with null checks
            const driverSaveBtn = document.getElementById('driver-save');
            if (driverSaveBtn) {
                driverSaveBtn.addEventListener('click', saveDriver);
            }
            
            const driverCancelBtn = document.getElementById('driver-cancel');
            if (driverCancelBtn) {
                driverCancelBtn.addEventListener('click', closeModal);
            }
            
            const carSaveBtn = document.getElementById('car-save');
            if (carSaveBtn) {
                carSaveBtn.addEventListener('click', saveCar);
            }
            
            const carCancelBtn = document.getElementById('car-cancel');
            if (carCancelBtn) {
                carCancelBtn.addEventListener('click', closeModal);
            }
            
            const cardSaveBtn = document.getElementById('card-save');
            if (cardSaveBtn) {
                cardSaveBtn.addEventListener('click', saveCard);
            }
            
            const cardCancelBtn = document.getElementById('card-cancel');
            if (cardCancelBtn) {
                cardCancelBtn.addEventListener('click', closeModal);
            }
            
            const tenderSaveBtn = document.getElementById('tender-save');
            if (tenderSaveBtn) {
                tenderSaveBtn.addEventListener('click', saveTender);
            }
            
            const tenderCancelBtn = document.getElementById('tender-cancel');
            if (tenderCancelBtn) {
                tenderCancelBtn.addEventListener('click', closeModal);
            }
            
            const invoiceSaveBtn = document.getElementById('invoice-save');
            if (invoiceSaveBtn) {
                invoiceSaveBtn.addEventListener('click', saveInvoice);
            }
            
            const invoiceCancelBtn = document.getElementById('invoice-cancel');
            if (invoiceCancelBtn) {
                invoiceCancelBtn.addEventListener('click', closeModal);
            }
            
            const userSaveBtn = document.getElementById('user-save');
            if (userSaveBtn) {
                userSaveBtn.addEventListener('click', saveUser);
            }
            
            const userCancelBtn = document.getElementById('user-cancel');
            if (userCancelBtn) {
                userCancelBtn.addEventListener('click', closeModal);
            }
            
            const statusSaveBtn = document.getElementById('status-save');
            if (statusSaveBtn) {
                statusSaveBtn.addEventListener('click', saveStatus);
            }
            
            const statusCancelBtn = document.getElementById('status-cancel');
            if (statusCancelBtn) {
                statusCancelBtn.addEventListener('click', closeModal);
            }
            
            const cartypeSaveBtn = document.getElementById('cartype-save');
            if (cartypeSaveBtn) {
                cartypeSaveBtn.addEventListener('click', saveCarType);
            }
            
            const cartypeCancelBtn = document.getElementById('cartype-cancel');
            if (cartypeCancelBtn) {
                cartypeCancelBtn.addEventListener('click', closeModal);
            }

            // Add buttons with null checks
            const addDriverBtn = document.getElementById('add-driver-btn');
            if (addDriverBtn) {
                addDriverBtn.addEventListener('click', () => openModal('driver'));
            }
            
            const addCarBtn = document.getElementById('add-car-btn');
            if (addCarBtn) {
                addCarBtn.addEventListener('click', () => openModal('car'));
            }
            
            const addCardBtn = document.getElementById('add-card-btn');
            if (addCardBtn) {
                addCardBtn.addEventListener('click', () => openModal('card'));
            }
            
            const addTenderBtn = document.getElementById('add-tender-btn');
            if (addTenderBtn) {
                addTenderBtn.addEventListener('click', () => openModal('tender'));
            }
            
            const addInvoiceBtn = document.getElementById('add-invoice-btn');
            if (addInvoiceBtn) {
                addInvoiceBtn.addEventListener('click', () => openModal('invoice'));
            }
            
            const addUserBtn = document.getElementById('add-user-btn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', () => openModal('user'));
            }
            
            const addStatusBtn = document.getElementById('add-status-btn');
            if (addStatusBtn) {
                addStatusBtn.addEventListener('click', () => openModal('status'));
            }
            
            const addCartypeBtn = document.getElementById('add-cartype-btn');
            if (addCartypeBtn) {
                addCartypeBtn.addEventListener('click', () => openModal('cartype'));
            }
            
            const addDriverStatusBtn = document.getElementById('add-driver-status-btn');
            if (addDriverStatusBtn) {
                addDriverStatusBtn.addEventListener('click', () => openModal('status', null, STATUS_TYPES.DRIVER));
            }
            
            const addCarStatusBtn = document.getElementById('add-car-status-btn');
            if (addCarStatusBtn) {
                addCarStatusBtn.addEventListener('click', () => openModal('status', null, STATUS_TYPES.CAR));
            }

            // Tabs with null checks
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    activateTab(tabId);
                });
            });

            // Status type filter with null check
            const statusTypeFilter = document.getElementById('status-type-filter');
            if (statusTypeFilter) {
                statusTypeFilter.addEventListener('change', function() {
                    const type = this.value;
                    if (type === 'all') {
                        renderStatuses();
                    } else {
                        renderStatuses(type);
                    }
                });
            }

            // Status type change in status modal with null check
            const statusType = document.getElementById('status-type');
            if (statusType) {
                statusType.addEventListener('change', function() {
                    const type = this.value;
                    populateParentStatuses(type);
                });
            }

            // Status level change in status modal with null check
            const statusIsPrimary = document.getElementById('status-is-primary');
            if (statusIsPrimary) {
                statusIsPrimary.addEventListener('change', function() {
                    const isPrimary = this.value === 'true';
                    document.getElementById('status-parent-container').style.display = isPrimary ? 'none' : 'block';
                    
                    if (!isPrimary) {
                        const type = document.getElementById('status-type').value;
                        populateParentStatuses(type);
                    }
                });
            }

            // Status change in tender modal with null check
            const tenderStatus = document.getElementById('tender-status');
            if (tenderStatus) {
                tenderStatus.addEventListener('change', function() {
                    const statusId = this.value;
                    populateSubStatuses(statusId);
                });
            }

            // Chat with null checks
            const chatSendBtn = document.getElementById('chat-send');
            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', sendMessage);
            }
            
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // Car type tandem configuration
            const cartypeIsTandem = document.getElementById('cartype-is-tandem');
            if (cartypeIsTandem) {
                cartypeIsTandem.addEventListener('change', function() {
                    const trailerDimensions = document.getElementById('trailer-dimensions');
                    if (trailerDimensions) {
                        trailerDimensions.classList.toggle('hidden', this.value === 'false');
                        calculateCarTypeCubicCapacity();
                        calculateCarTypeWeight();
                    }
                });
            }
            
            // Car type dimensions change
            const cartypeLength = document.getElementById('cartype-length');
            const cartypeWidth = document.getElementById('cartype-width');
            const cartypeHeight = document.getElementById('cartype-height');
            const cartypeMainWeight = document.getElementById('cartype-main-weight');
            const cartypeTrailerLength = document.getElementById('cartype-trailer-length');
            const cartypeTrailerWidth = document.getElementById('cartype-trailer-width');
            const cartypeTrailerHeight = document.getElementById('cartype-trailer-height');
            const cartypeTrailerWeight = document.getElementById('cartype-trailer-weight');
            
            if (cartypeLength) cartypeLength.addEventListener('input', calculateCarTypeCubicCapacity);
            if (cartypeWidth) cartypeWidth.addEventListener('input', calculateCarTypeCubicCapacity);
            if (cartypeHeight) cartypeHeight.addEventListener('input', calculateCarTypeCubicCapacity);
            if (cartypeMainWeight) cartypeMainWeight.addEventListener('input', calculateCarTypeWeight);
            if (cartypeTrailerLength) cartypeTrailerLength.addEventListener('input', calculateCarTypeCubicCapacity);
            if (cartypeTrailerWidth) cartypeTrailerWidth.addEventListener('input', calculateCarTypeCubicCapacity);
            if (cartypeTrailerHeight) cartypeTrailerHeight.addEventListener('input', calculateCarTypeCubicCapacity);
            if (cartypeTrailerWeight) cartypeTrailerWeight.addEventListener('input', calculateCarTypeWeight);
            
            // Car type selection in car modal
            const carTypeSelect = document.getElementById('car-type');
            if (carTypeSelect) {
                carTypeSelect.addEventListener('change', function() {
                    updateCarTypeDetails(this.value);
                });
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const availableCards = document.getElementById('available-cards');
            const assignedCards = document.getElementById('assigned-cards');

            // Make statuses draggable for hierarchy
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('status-hierarchy-item')) {
                    e.dataTransfer.setData('text/plain', e.target.dataset.statusId);
                    e.target.classList.add('dragging');
                }
            });

            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('status-hierarchy-item')) {
                    e.target.classList.remove('dragging');
                }
            });

            // Handle status hierarchy drop zones
            document.querySelectorAll('.status-hierarchy').forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('highlight');
                });

                zone.addEventListener('dragleave', function() {
                    this.classList.remove('highlight');
                });

                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                    
                    const statusId = e.dataTransfer.getData('text/plain');
                    const target = e.target.closest('.status-hierarchy-item');
                    
                    if (target) {
                        const targetStatusId = target.dataset.statusId;
                        const statusType = this.dataset.type;
                        
                        // Update the status hierarchy
                        updateStatusHierarchy(statusId, targetStatusId, statusType);
                    }
                });
            });

            // Make cards draggable
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('draggable')) {
                    e.dataTransfer.setData('text/plain', e.target.dataset.cardId);
                    e.target.classList.add('dragging');
                }
            });

            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('draggable')) {
                    e.target.classList.remove('dragging');
                }
            });

            // Handle drop zones
            [availableCards, assignedCards].forEach(zone => {
                if (zone) {
                    zone.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.classList.add('highlight');
                    });

                    zone.addEventListener('dragleave', function() {
                        this.classList.remove('highlight');
                    });

                    zone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('highlight');
                        
                        const cardId = e.dataTransfer.getData('text/plain');
                        const card = state.cards.data.find(c => c.id === cardId);
                        
                        if (card) {
                            // In a real app, we would update the card assignment
                            addNotification('Card assignment updated', 'success');
                        }
                    });
                }
            });
        }

        // Authentication handlers
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const token = document.getElementById('login-token').value;
            const repo = document.getElementById('login-repo').value;

            if (!email || !password || !token || !repo) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                // Test GitHub connection by getting user info
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid token');
                }

                const userData = await response.json();
                const login = userData.login;

                // Check if repository exists
                const repoResponse = await fetch(`https://api.github.com/repos/${login}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!repoResponse.ok) {
                    if (repoResponse.status === 404) {
                        throw new Error('Repository not found');
                    } else {
                        throw new Error(`GitHub API error: ${repoResponse.status}`);
                    }
                }

                // Check if users file exists and user exists
                try {
                    const contentResponse = await fetch(`https://api.github.com/repos/${login}/${repo}/contents/${FILE_PATHS.USERS}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!contentResponse.ok) {
                        if (contentResponse.status === 404) {
                            throw new Error('Users database not found');
                        } else {
                            throw new Error(`GitHub API error: ${contentResponse.status}`);
                        }
                    }

                    const contentData = await contentResponse.json();
                    const content = base64ToUtf8(contentData.content);
                    const users = JSON.parse(content);
                    const user = users.find(u => u.email === email && u.password === password);

                    // CRITICAL FIX: Add error logging to see what's happening
                    console.log('Users from GitHub:', users);
                    console.log('Looking for user with email:', email, 'and password:', password);
                    console.log('Found user:', user);

                    if (user) {
                        state.currentUser = user;
                        state.githubToken = token;
                        state.repoName = repo;
                        localStorage.setItem('transforward_user', JSON.stringify(user));
                        showApp();
                        validateAndInitializeDatabase();
                        addNotification('Login successful', 'success');
                    } else {
                        // More specific error message
                        addNotification('Invalid credentials or user not found in repository', 'error');
                        console.error('User not found in repository. Email:', email);
                    }
                } catch (error) {
                    addNotification('Users database not found: ' + error.message, 'error');
                    console.error('Error reading users file:', error);
                }
            } catch (error) {
                addNotification('Invalid repository or token: ' + error.message, 'error');
                console.error('Login error:', error);
            }
        }

        async function handleRegister() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const token = document.getElementById('register-token').value;
            const repo = document.getElementById('register-repo').value;

            if (!email || !password || !token || !repo) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                // Test GitHub connection
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid token');
                }

                const userData = await response.json();
                const login = userData.login;

                // Create repository
                const createRepoResponse = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: repo,
                        description: 'TransForward Manager Database',
                        private: true,
                        auto_init: true
                    })
                });

                if (!createRepoResponse.ok) {
                    const errorData = await createRepoResponse.json();
                    throw new Error(errorData.message || 'Failed to create repository');
                }

                // Create data directory
                const createDirResponse = await fetch(`https://api.github.com/repos/${login}/${repo}/contents/data/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Create data directory',
                        content: ''
                    })
                });

                if (!createDirResponse.ok && createDirResponse.status !== 422) { // 422 means already exists
                    const errorData = await createDirResponse.json();
                    throw new Error(errorData.message || 'Failed to create data directory');
                }

                // Initialize all database files
                await initializeAllDatabaseFiles(login, token, repo);
                
                // Set current user
                state.currentUser = {
                    id: generateId(),
                    name: 'Admin',
                    lastname: 'User',
                    email: email,
                    password: password,
                    status: 'admin',
                    supervisor: null,
                    createdAt: new Date().toISOString()
                };
                state.currentUser.token = token;
                state.currentUser.repo = repo;
                state.githubToken = token;
                state.repoName = repo;
                
                localStorage.setItem('transforward_user', JSON.stringify(state.currentUser));
                
                showApp();
                validateAndInitializeDatabase();
                addNotification('Registration successful', 'success');
            } catch (error) {
                addNotification('Registration failed: ' + error.message, 'error');
                console.error('Registration error:', error);
            }
        }

        async function initializeAllDatabaseFiles(login, token, repo) {
            try {
                // Get active status ID for initialization
                const activeStatusId = generateId();
                const unassignedStatusId = generateId();

                // Initialize users file
                const usersData = [{
                    id: generateId(),
                    name: 'Admin',
                    lastname: 'User',
                    email: document.getElementById('register-email').value,
                    password: document.getElementById('register-password').value,
                    status: 'admin',
                    supervisor: null,
                    createdAt: new Date().toISOString()
                }];
                
                await updateFile(
                    FILE_PATHS.USERS,
                    'Initialize users database',
                    utf8ToBase64(JSON.stringify(usersData, null, 2)),
                    null
                );

                // Initialize statuses file
                const statusesData = [
                    // Driver statuses
                    { 
                        id: unassignedStatusId, 
                        name: 'Unassigned', 
                        type: 'driver', 
                        color: 'inactive', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: activeStatusId, 
                        name: 'Active', 
                        type: 'driver', 
                        color: 'active', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'On Break', 
                        type: 'driver', 
                        color: 'warning', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'On Vacation', 
                        type: 'driver', 
                        color: 'warning', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'No Time', 
                        type: 'driver', 
                        color: 'inactive', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    // Sub-statuses for Active
                    { 
                        id: generateId(), 
                        name: 'Awaiting Loading', 
                        type: 'driver', 
                        color: 'pending', 
                        isPrimary: false, 
                        parentStatusId: activeStatusId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Loading', 
                        type: 'driver', 
                        color: 'warning', 
                        isPrimary: false, 
                        parentStatusId: activeStatusId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'In Transit', 
                        type: 'driver', 
                        color: 'active', 
                        isPrimary: false, 
                        parentStatusId: activeStatusId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Awaiting Unloading', 
                        type: 'driver', 
                        color: 'pending', 
                        isPrimary: false, 
                        parentStatusId: activeStatusId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Unloading', 
                        type: 'driver', 
                        color: 'warning', 
                        isPrimary: false, 
                        parentStatusId: activeStatusId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    // Car statuses
                    { 
                        id: generateId(), 
                        name: 'Active', 
                        type: 'car', 
                        color: 'active', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Inactive', 
                        type: 'car', 
                        color: 'inactive', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Maintenance', 
                        type: 'car', 
                        color: 'warning', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Inspection Due', 
                        type: 'car', 
                        color: 'danger', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    // Card statuses
                    { 
                        id: generateId(), 
                        name: 'Active', 
                        type: 'card', 
                        color: 'active', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Inactive', 
                        type: 'card', 
                        color: 'inactive', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Expired', 
                        type: 'card', 
                        color: 'danger', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Expiring Soon', 
                        type: 'card', 
                        color: 'warning', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    // Tender statuses
                    { 
                        id: generateId(), 
                        name: 'Unassigned', 
                        type: 'tender', 
                        color: 'inactive', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Pending', 
                        type: 'tender', 
                        color: 'pending', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'On Route', 
                        type: 'tender', 
                        color: 'active', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Delivered', 
                        type: 'tender', 
                        color: 'completed', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Cancelled', 
                        type: 'tender', 
                        color: 'danger', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Sold', 
                        type: 'tender', 
                        color: 'success', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    // Invoice statuses
                    { 
                        id: generateId(), 
                        name: 'Pending', 
                        type: 'invoice', 
                        color: 'pending', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Paid', 
                        type: 'invoice', 
                        color: 'completed', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Unpaid', 
                        type: 'invoice', 
                        color: 'warning', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    { 
                        id: generateId(), 
                        name: 'Overdue', 
                        type: 'invoice', 
                        color: 'danger', 
                        isPrimary: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                await updateFile(
                    FILE_PATHS.STATUSES,
                    'Initialize statuses database',
                    utf8ToBase64(JSON.stringify(statusesData, null, 2)),
                    null
                );

                // Initialize cars file (with car types)
                const carsData = {
                    data: [],
                    carTypes: [
                        { 
                            id: generateId(), 
                            name: 'Semi-Trailer', 
                            description: 'Standard semi-trailer with one long trailer',
                            mainDimensions: {
                                length: 13.6,
                                width: 2.45,
                                height: 2.7
                            },
                            trailerDimensions: null,
                            mainMaxWeight: 24,
                            trailerMaxWeight: 0,
                            isTandem: false,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Jumbo', 
                            description: 'Split into 2 cars in tandem',
                            mainDimensions: {
                                length: 13.6,
                                width: 2.45,
                                height: 2.7
                            },
                            trailerDimensions: {
                                length: 13.6,
                                width: 2.45,
                                height: 2.7
                            },
                            mainMaxWeight: 20,
                            trailerMaxWeight: 20,
                            isTandem: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ]
                };
                
                await updateFile(
                    FILE_PATHS.CARS,
                    'Initialize cars database',
                    utf8ToBase64(JSON.stringify(carsData, null, 2)),
                    null
                );

                // Initialize empty files for other data types
                const emptyData = [];
                
                await updateFile(
                    FILE_PATHS.DRIVERS,
                    'Initialize drivers database',
                    utf8ToBase64(JSON.stringify(emptyData, null, 2)),
                    null
                );
                
                await updateFile(
                    FILE_PATHS.CARDS,
                    'Initialize cards database',
                    utf8ToBase64(JSON.stringify(emptyData, null, 2)),
                    null
                );
                
                await updateFile(
                    FILE_PATHS.TENDERS,
                    'Initialize tenders database',
                    utf8ToBase64(JSON.stringify(emptyData, null, 2)),
                    null
                );
                
                await updateFile(
                    FILE_PATHS.INVOICES,
                    'Initialize invoices database',
                    utf8ToBase64(JSON.stringify(emptyData, null, 2)),
                    null
                );
                
                await updateFile(
                    FILE_PATHS.CHAT,
                    'Initialize chat database',
                    utf8ToBase64(JSON.stringify(emptyData, null, 2)),
                    null
                );
            } catch (error) {
                throw new Error('Failed to initialize database files: ' + error.message);
            }
        }

        // GitHub API functions
        async function createFile(path, message, content) {
            const login = await getCurrentUserLogin();
            const response = await fetch(`https://api.github.com/repos/${login}/${state.repoName}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${state.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    content: content
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create file');
            }
        }

        async function updateFile(path, message, content, sha = null) {
            const login = await getCurrentUserLogin();
            const data = {
                message: message,
                content: content
            };
            
            if (sha) {
                data.sha = sha;
            }

            const response = await fetch(`https://api.github.com/repos/${login}/${state.repoName}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${state.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update file');
            }
            
            return response.json();
        }

        async function readFile(path) {
            const login = await getCurrentUserLogin();
            try {
                const response = await fetch(`https://api.github.com/repos/${login}/${state.repoName}/contents/${path}`, {
                    headers: {
                        'Authorization': `token ${state.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Return empty structure based on file path
                        if (path === FILE_PATHS.CARS) {
                            return { 
                                data: { 
                                    data: [], 
                                    carTypes: [] 
                                }, 
                                sha: null 
                            };
                        }
                        return { data: [], sha: null };
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.content) {
                    const parsedData = JSON.parse(base64ToUtf8(data.content));
                    
                    // Special handling for cars.json to ensure it has the correct structure
                    if (path === FILE_PATHS.CARS) {
                        return {
                            data: {
                                data: parsedData.data || [],
                                carTypes: parsedData.carTypes || []
                            },
                            sha: data.sha
                        };
                    }
                    
                    return {
                        data: parsedData,
                        sha: data.sha
                    };
                }
                // Return empty structure based on file path
                if (path === FILE_PATHS.CARS) {
                    return { 
                        data: { 
                            data: [], 
                            carTypes: [] 
                        }, 
                        sha: null 
                    };
                }
                return { data: [], sha: null };
            } catch (error) {
                if (error.message.includes('404')) {
                    // Return empty structure based on file path
                    if (path === FILE_PATHS.CARS) {
                        return { 
                            data: { 
                                data: [], 
                                carTypes: [] 
                            }, 
                            sha: null 
                        };
                    }
                    return { data: [], sha: null };
                }
                throw error;
            }
        }

        async function getCurrentUserLogin() {
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `token ${state.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            const userData = await response.json();
            return userData.login;
        }

        async function loadAllData() {
            try {
                // Load all data with SHA
                const driversData = await readFile(FILE_PATHS.DRIVERS);
                state.drivers = { 
                    data: driversData.data || [], 
                    sha: driversData.sha 
                };
                
                const carsData = await readFile(FILE_PATHS.CARS);
                state.cars = { 
                    data: carsData.data || { 
                        data: [], 
                        carTypes: [] 
                    }, 
                    sha: carsData.sha 
                };
                
                const cardsData = await readFile(FILE_PATHS.CARDS);
                state.cards = { 
                    data: cardsData.data || [], 
                    sha: cardsData.sha 
                };
                
                const tendersData = await readFile(FILE_PATHS.TENDERS);
                state.tenders = { 
                    data: tendersData.data || [], 
                    sha: tendersData.sha 
                };
                
                const invoicesData = await readFile(FILE_PATHS.INVOICES);
                state.invoices = { 
                    data: invoicesData.data || [], 
                    sha: invoicesData.sha 
                };
                
                const usersData = await readFile(FILE_PATHS.USERS);
                state.users = { 
                    data: usersData.data || [], 
                    sha: usersData.sha 
                };
                
                const statusesData = await readFile(FILE_PATHS.STATUSES);
                state.statuses = { 
                    data: statusesData.data || [], 
                    sha: statusesData.sha 
                };
                
                const chatData = await readFile(FILE_PATHS.CHAT);
                state.chat = { 
                    data: chatData.data || [], 
                    sha: chatData.sha 
                };

                // Update UI
                updateDashboardStats();
                checkExpirations();
                loadDataForView(state.currentView);
                
                // Set up periodic checks
                setInterval(checkExpirations, 300000); // Check every 5 minutes
                
                // Update driver statuses based on tenders
                updateAllDriverStatuses();
            } catch (error) {
                addNotification('Failed to load data: ' + error.message, 'error');
                console.error('Load data error:', error);
            }
        }

        // Database validation and initialization
        async function validateAndInitializeDatabase() {
            try {
                const login = await getCurrentUserLogin();
                
                // Check if all required files exist
                const requiredFiles = Object.values(FILE_PATHS);
                
                for (const filePath of requiredFiles) {
                    try {
                        const response = await fetch(`https://api.github.com/repos/${login}/${state.repoName}/contents/${filePath}`, {
                            headers: {
                                'Authorization': `token ${state.githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (!response.ok) {
                            if (response.status === 404) {
                                // File doesn't exist, initialize it
                                await initializeFile(filePath);
                            } else {
                                throw new Error(`GitHub API error: ${response.status}`);
                            }
                        } else {
                            // File exists, check if it has the correct structure
                            const fileData = await response.json();
                            const content = JSON.parse(base64ToUtf8(fileData.content));
                            
                            // Special check for cars.json
                            if (filePath === FILE_PATHS.CARS) {
                                if (!content.data || !content.carTypes) {
                                    // File exists but has incorrect structure
                                    await initializeFile(filePath);
                                }
                            }
                        }
                    } catch (error) {
                        if (error.message.includes('404')) {
                            // File doesn't exist, initialize it
                            await initializeFile(filePath);
                        } else {
                            console.error(`Error validating file ${filePath}:`, error);
                        }
                    }
                }
                
                // Load all data after validation
                await loadAllData();
            } catch (error) {
                console.error('Database validation error:', error);
                addNotification('Failed to validate database: ' + error.message, 'error');
            }
        }

        async function initializeFile(filePath) {
            try {
                const login = await getCurrentUserLogin();
                
                // Create the appropriate initial data based on file path
                let initialData;
                
                if (filePath === FILE_PATHS.DRIVERS) {
                    initialData = [];
                } else if (filePath === FILE_PATHS.CARS) {
                    initialData = {
                        data: [],
                        carTypes: [
                            { 
                                id: generateId(), 
                                name: 'Semi-Trailer', 
                                description: 'Standard semi-trailer with one long trailer',
                                mainDimensions: {
                                    length: 13.6,
                                    width: 2.45,
                                    height: 2.7
                                },
                                trailerDimensions: null,
                                mainMaxWeight: 24,
                                trailerMaxWeight: 0,
                                isTandem: false,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            },
                            { 
                                id: generateId(), 
                                name: 'Jumbo', 
                                description: 'Split into 2 cars in tandem',
                                mainDimensions: {
                                    length: 13.6,
                                    width: 2.45,
                                    height: 2.7
                                },
                                trailerDimensions: {
                                    length: 13.6,
                                    width: 2.45,
                                    height: 2.7
                                },
                                mainMaxWeight: 20,
                                trailerMaxWeight: 20,
                                isTandem: true,
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }
                        ]
                    };
                } else if (filePath === FILE_PATHS.CARDS) {
                    initialData = [];
                } else if (filePath === FILE_PATHS.TENDERS) {
                    initialData = [];
                } else if (filePath === FILE_PATHS.INVOICES) {
                    initialData = [];
                } else if (filePath === FILE_PATHS.USERS) {
                    initialData = [];
                } else if (filePath === FILE_PATHS.STATUSES) {
                    // Get active status ID for initialization
                    const activeStatusId = generateId();
                    const unassignedStatusId = generateId();
                    
                    initialData = [
                        // Driver statuses
                        { 
                            id: unassignedStatusId, 
                            name: 'Unassigned', 
                            type: 'driver', 
                            color: 'inactive', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: activeStatusId, 
                            name: 'Active', 
                            type: 'driver', 
                            color: 'active', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'On Break', 
                            type: 'driver', 
                            color: 'warning', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'On Vacation', 
                            type: 'driver', 
                            color: 'warning', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'No Time', 
                            type: 'driver', 
                            color: 'inactive', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        // Sub-statuses for Active
                        { 
                            id: generateId(), 
                            name: 'Awaiting Loading', 
                            type: 'driver', 
                            color: 'pending', 
                            isPrimary: false, 
                            parentStatusId: activeStatusId,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Loading', 
                            type: 'driver', 
                            color: 'warning', 
                            isPrimary: false, 
                            parentStatusId: activeStatusId,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'In Transit', 
                            type: 'driver', 
                            color: 'active', 
                            isPrimary: false, 
                            parentStatusId: activeStatusId,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Awaiting Unloading', 
                            type: 'driver', 
                            color: 'pending', 
                            isPrimary: false, 
                            parentStatusId: activeStatusId,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Unloading', 
                            type: 'driver', 
                            color: 'warning', 
                            isPrimary: false, 
                            parentStatusId: activeStatusId,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        // Car statuses
                        { 
                            id: generateId(), 
                            name: 'Active', 
                            type: 'car', 
                            color: 'active', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Inactive', 
                            type: 'car', 
                            color: 'inactive', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Maintenance', 
                            type: 'car', 
                            color: 'warning', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Inspection Due', 
                            type: 'car', 
                            color: 'danger', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        // Card statuses
                        { 
                            id: generateId(), 
                            name: 'Active', 
                            type: 'card', 
                            color: 'active', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Inactive', 
                            type: 'card', 
                            color: 'inactive', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Expired', 
                            type: 'card', 
                            color: 'danger', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Expiring Soon', 
                            type: 'card', 
                            color: 'warning', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        // Tender statuses
                        { 
                            id: generateId(), 
                            name: 'Unassigned', 
                            type: 'tender', 
                            color: 'inactive', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Pending', 
                            type: 'tender', 
                            color: 'pending', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'On Route', 
                            type: 'tender', 
                            color: 'active', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Delivered', 
                            type: 'tender', 
                            color: 'completed', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Cancelled', 
                            type: 'tender', 
                            color: 'danger', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Sold', 
                            type: 'tender', 
                            color: 'success', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        // Invoice statuses
                        { 
                            id: generateId(), 
                            name: 'Pending', 
                            type: 'invoice', 
                            color: 'pending', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Paid', 
                            type: 'invoice', 
                            color: 'completed', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Unpaid', 
                            type: 'invoice', 
                            color: 'warning', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        { 
                            id: generateId(), 
                            name: 'Overdue', 
                            type: 'invoice', 
                            color: 'danger', 
                            isPrimary: true,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ];
                } else if (filePath === FILE_PATHS.CHAT) {
                    initialData = [];
                }
                
                // Create the file
                const response = await fetch(`https://api.github.com/repos/${login}/${state.repoName}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${state.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Initialize database file',
                        content: utf8ToBase64(JSON.stringify(initialData, null, 2))
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to initialize file');
                }
                
                addNotification(`Initialized database file: ${filePath}`, 'success');
            } catch (error) {
                console.error(`Error initializing file ${filePath}:`, error);
                addNotification(`Failed to initialize ${filePath}: ${error.message}`, 'error');
            }
        }

        // Status management functions
        function getStatusById(statusId) {
            return state.statuses.data.find(status => status.id === statusId);
        }

        function getPrimaryStatuses(type) {
            return state.statuses.data.filter(status => 
                status.type === type && status.isPrimary
            );
        }

        function getSubStatuses(parentStatusId) {
            return state.statuses.data.filter(status => 
                status.parentStatusId === parentStatusId
            );
        }

        function getDriverPrimaryStatuses() {
            return getPrimaryStatuses(STATUS_TYPES.DRIVER);
        }

        function getDriverSubStatuses(parentStatusId) {
            return getSubStatuses(parentStatusId);
        }

        function getCarStatuses() {
            return state.statuses.data.filter(status => status.type === STATUS_TYPES.CAR);
        }

        function getCardStatuses() {
            return state.statuses.data.filter(status => status.type === STATUS_TYPES.CARD);
        }

        function getTenderStatuses() {
            return state.statuses.data.filter(status => status.type === STATUS_TYPES.TENDER);
        }

        function getInvoiceStatuses() {
            return state.statuses.data.filter(status => status.type === STATUS_TYPES.INVOICE);
        }

        function getCarTypeById(carTypeId) {
            return state.cars.data.carTypes.find(type => type.id === carTypeId);
        }

        function getStatusColorClass(status) {
            return STATUS_COLORS[status.color] || 'status-active';
        }

        // Driver status calculation functions
        function updateAllDriverStatuses() {
            state.drivers.data.forEach(driver => {
                updateDriverStatus(driver.id);
            });
        }

        function updateDriverStatus(driverId) {
            const driver = state.drivers.data.find(d => d.id === driverId);
            if (!driver) return;
            
            // Check if on vacation
            if (driver.onVacation === 'true') {
                setDriverStatus(driverId, getDriverPrimaryStatuses().find(s => s.name === 'On Vacation').id, null);
                return;
            }
            
            // Check if on break
            if (driver.onBreak === 'true') {
                setDriverStatus(driverId, getDriverPrimaryStatuses().find(s => s.name === 'On Break').id, null);
                return;
            }
            
            // Check work hours
            const now = new Date();
            const currentHour = now.getHours();
            const workHours = driver.workHours ? driver.workHours.split('-') : ['8:00', '17:00'];
            const startHour = parseInt(workHours[0].split(':')[0]);
            const endHour = parseInt(workHours[1].split(':')[0]);
            
            if (currentHour < startHour || currentHour >= endHour) {
                setDriverStatus(driverId, getDriverPrimaryStatuses().find(s => s.name === 'No Time').id, null);
                return;
            }
            
            // Check if has active tender
            const activeTender = state.tenders.data.find(t => 
                t.driver === driverId && 
                t.status !== getTenderStatuses().find(s => s.name === 'Cancelled').id &&
                t.status !== getTenderStatuses().find(s => s.name === 'Delivered').id
            );
            
            if (activeTender) {
                // Check tender status
                const tenderStatus = getStatusById(activeTender.status);
                let primaryStatusId = getDriverPrimaryStatuses().find(s => s.name === 'Active').id;
                let subStatusId = activeTender.subStatus;
                
                setDriverStatus(driverId, primaryStatusId, subStatusId);
            } else {
                const unassignedStatus = getDriverPrimaryStatuses().find(s => s.name === 'Unassigned');
                setDriverStatus(driverId, unassignedStatus ? unassignedStatus.id : null, null);
            }
        }

        function setDriverStatus(driverId, primaryStatusId, subStatusId) {
            // Update driver status
            state.drivers.data = state.drivers.data.map(driver => {
                if (driver.id === driverId) {
                    return {
                        ...driver,
                        status: primaryStatusId,
                        subStatus: subStatusId
                    };
                }
                return driver;
            });
        }

        function handleTenderStatusChange(tenderId, newStatusId, newSubStatusId) {
            // Update tender status
            state.tenders.data = state.tenders.data.map(tender => {
                if (tender.id === tenderId) {
                    return {
                        ...tender,
                        status: newStatusId,
                        subStatus: newSubStatusId
                    };
                }
                return tender;
            });
            
            // If tender has a driver, update driver status
            const tender = state.tenders.data.find(t => t.id === tenderId);
            if (tender && tender.driver) {
                updateDriverStatus(tender.driver);
            }
        }

        // CRUD Operations
        async function saveDriver() {
            const name = document.getElementById('driver-name').value;
            const lastname = document.getElementById('driver-lastname').value;
            const car = document.getElementById('driver-car').value;
            const card = document.getElementById('driver-card').value;
            const onBreak = document.getElementById('driver-on-break').value;
            const onVacation = document.getElementById('driver-on-vacation').value;
            const workHours = document.getElementById('driver-work-hours').value;
            const modalTitle = document.getElementById('driver-modal-title').textContent;

            if (!name || !lastname || !workHours) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const { data: drivers, sha } = await readFile(FILE_PATHS.DRIVERS) || { data: [], sha: null };
                const now = new Date().toISOString();

                let updatedDrivers;
                if (modalTitle === 'Add Driver') {
                    // Add new driver
                    const newDriver = {
                        id: generateId(),
                        name: name,
                        lastname: lastname,
                        car: car,
                        card: card,
                        onBreak: onBreak,
                        onVacation: onVacation,
                        workHours: workHours,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedDrivers = [...drivers, newDriver];
                } else {
                    // Update existing driver
                    const driverId = document.getElementById('driver-modal').getAttribute('data-id');
                    updatedDrivers = drivers.map(driver => {
                        if (driver.id === driverId) {
                            return {
                                ...driver,
                                name: name,
                                lastname: lastname,
                                car: car,
                                card: card,
                                onBreak: onBreak,
                                onVacation: onVacation,
                                workHours: workHours,
                                updatedAt: now
                            };
                        }
                        return driver;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.DRIVERS,
                    modalTitle === 'Add Driver' ? 'Add driver' : 'Update driver',
                    utf8ToBase64(JSON.stringify(updatedDrivers, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.drivers = { 
                    data: updatedDrivers, 
                    sha: result.content.sha 
                };
                closeModal();
                renderDrivers();
                addNotification('Driver saved successfully', 'success');
                
                // Update driver statuses
                updateAllDriverStatuses();
            } catch (error) {
                addNotification('Failed to save driver: ' + error.message, 'error');
                console.error('Save driver error:', error);
            }
        }

        async function saveCar() {
            const tractor = document.getElementById('car-tractor').value;
            const trailer = document.getElementById('car-trailer').value;
            const carType = document.getElementById('car-type').value;
            const insurance = document.getElementById('car-insurance').value;
            const inspection = document.getElementById('car-inspection').value;
            const insuranceNotify = document.getElementById('car-insurance-notify').value;
            const inspectionNotify = document.getElementById('car-inspection-notify').value;
            const status = document.getElementById('car-status').value;
            const modalTitle = document.getElementById('car-modal-title').textContent;

            if (!tractor || !trailer || !insurance || !inspection) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const { data: carsData, sha } = await readFile(FILE_PATHS.CARS) || { 
                    data: { 
                        data: [], 
                        carTypes: [] 
                    }, 
                    sha: null 
                };
                const now = new Date().toISOString();

                let updatedCars;
                if (modalTitle === 'Add Car') {
                    // Add new car
                    const newCar = {
                        id: generateId(),
                        tractor: tractor,
                        trailer: trailer,
                        carType: carType,
                        insurance: insurance,
                        inspection: inspection,
                        insuranceNotify: parseInt(insuranceNotify),
                        inspectionNotify: parseInt(inspectionNotify),
                        status: status,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedCars = [...carsData.data, newCar];
                } else {
                    // Update existing car
                    const carId = document.getElementById('car-modal').getAttribute('data-id');
                    updatedCars = carsData.data.map(car => {
                        if (car.id === carId) {
                            return {
                                ...car,
                                tractor: tractor,
                                trailer: trailer,
                                carType: carType,
                                insurance: insurance,
                                inspection: inspection,
                                insuranceNotify: parseInt(insuranceNotify),
                                inspectionNotify: parseInt(inspectionNotify),
                                status: status,
                                updatedAt: now
                            };
                        }
                        return car;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.CARS,
                    modalTitle === 'Add Car' ? 'Add car' : 'Update car',
                    utf8ToBase64(JSON.stringify({
                        ...carsData,
                        data: updatedCars
                    }, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.cars = { 
                    data: {
                        ...carsData,
                        data: updatedCars
                    }, 
                    sha: result.content.sha 
                };
                closeModal();
                renderCars();
                addNotification('Car saved successfully', 'success');
            } catch (error) {
                addNotification('Failed to save car: ' + error.message, 'error');
                console.error('Save car error:', error);
            }
        }

        async function saveCarType() {
            const name = document.getElementById('cartype-name').value;
            const description = document.getElementById('cartype-description').value;
            const length = document.getElementById('cartype-length').value;
            const width = document.getElementById('cartype-width').value;
            const height = document.getElementById('cartype-height').value;
            const mainWeight = document.getElementById('cartype-main-weight').value;
            const trailerLength = document.getElementById('cartype-trailer-length').value;
            const trailerWidth = document.getElementById('cartype-trailer-width').value;
            const trailerHeight = document.getElementById('cartype-trailer-height').value;
            const trailerWeight = document.getElementById('cartype-trailer-weight').value;
            const isTandem = document.getElementById('cartype-is-tandem').value;
            const modalTitle = document.getElementById('cartype-modal-title').textContent;

            if (!name || !length || !width || !height || !mainWeight) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            // For tandem vehicles, ensure trailer dimensions and weight are provided
            if (isTandem === 'true' && (!trailerLength || !trailerWidth || !trailerHeight || !trailerWeight)) {
                addNotification('Please provide trailer details for tandem vehicles', 'error');
                return;
            }

            try {
                const { data: carsData, sha } = await readFile(FILE_PATHS.CARS) || { 
                    data: { 
                        data: [], 
                        carTypes: [] 
                    }, 
                    sha: null 
                };
                const now = new Date().toISOString();

                let updatedCarTypes;
                if (modalTitle === 'Add Vehicle Type') {
                    // Add new car type
                    const newCarType = {
                        id: generateId(),
                        name: name,
                        description: description,
                        mainDimensions: {
                            length: parseFloat(length),
                            width: parseFloat(width),
                            height: parseFloat(height)
                        },
                        trailerDimensions: isTandem === 'true' ? {
                            length: parseFloat(trailerLength),
                            width: parseFloat(trailerWidth),
                            height: parseFloat(trailerHeight)
                        } : null,
                        mainMaxWeight: parseFloat(mainWeight),
                        trailerMaxWeight: isTandem === 'true' ? parseFloat(trailerWeight) : 0,
                        isTandem: isTandem === 'true',
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedCarTypes = [...carsData.carTypes, newCarType];
                } else {
                    // Update existing car type
                    const carTypeId = document.getElementById('cartype-modal').getAttribute('data-id');
                    updatedCarTypes = carsData.carTypes.map(carType => {
                        if (carType.id === carTypeId) {
                            return {
                                ...carType,
                                name: name,
                                description: description,
                                mainDimensions: {
                                    length: parseFloat(length),
                                    width: parseFloat(width),
                                    height: parseFloat(height)
                                },
                                trailerDimensions: isTandem === 'true' ? {
                                    length: parseFloat(trailerLength),
                                    width: parseFloat(trailerWidth),
                                    height: parseFloat(trailerHeight)
                                } : null,
                                mainMaxWeight: parseFloat(mainWeight),
                                trailerMaxWeight: isTandem === 'true' ? parseFloat(trailerWeight) : 0,
                                isTandem: isTandem === 'true',
                                updatedAt: now
                            };
                        }
                        return carType;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.CARS,
                    modalTitle === 'Add Vehicle Type' ? 'Add vehicle type' : 'Update vehicle type',
                    utf8ToBase64(JSON.stringify({
                        ...carsData,
                        carTypes: updatedCarTypes
                    }, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.cars = { 
                    data: {
                        ...carsData,
                        carTypes: updatedCarTypes
                    }, 
                    sha: result.content.sha 
                };
                closeModal();
                renderCarTypes();
                addNotification('Vehicle type saved successfully', 'success');
            } catch (error) {
                addNotification('Failed to save vehicle type: ' + error.message, 'error');
                console.error('Save vehicle type error:', error);
            }
        }

        async function saveCard() {
            const number = document.getElementById('card-number').value;
            const pin = document.getElementById('card-pin').value;
            const expiry = document.getElementById('card-expiry').value;
            const notify = document.getElementById('card-notify').value;
            const reminder = document.getElementById('card-reminder').value;
            const status = document.getElementById('card-status').value;
            const modalTitle = document.getElementById('card-modal-title').textContent;

            if (!number || !pin || !expiry) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const { data: cards, sha } = await readFile(FILE_PATHS.CARDS) || { data: [], sha: null };
                const now = new Date().toISOString();

                let updatedCards;
                if (modalTitle === 'Add Card') {
                    // Add new card
                    const newCard = {
                        id: generateId(),
                        number: number,
                        pin: pin,
                        expiry: expiry,
                        notify: parseInt(notify),
                        reminder: parseInt(reminder),
                        status: status,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedCards = [...cards, newCard];
                } else {
                    // Update existing card
                    const cardId = document.getElementById('card-modal').getAttribute('data-id');
                    updatedCards = cards.map(card => {
                        if (card.id === cardId) {
                            return {
                                ...card,
                                number: number,
                                pin: pin,
                                expiry: expiry,
                                notify: parseInt(notify),
                                reminder: parseInt(reminder),
                                status: status,
                                updatedAt: now
                            };
                        }
                        return card;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.CARDS,
                    modalTitle === 'Add Card' ? 'Add card' : 'Update card',
                    utf8ToBase64(JSON.stringify(updatedCards, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.cards = { 
                    data: updatedCards, 
                    sha: result.content.sha 
                };
                closeModal();
                renderCards();
                addNotification('Card saved successfully', 'success');
            } catch (error) {
                addNotification('Failed to save card: ' + error.message, 'error');
                console.error('Save card error:', error);
            }
        }

        async function saveTender() {
            const loadingDate = document.getElementById('tender-loading-date').value;
            const unloadingDate = document.getElementById('tender-unloading-date').value;
            const loadingCity = document.getElementById('tender-loading-city').value;
            const loadingZip = document.getElementById('tender-loading-zip').value;
            const unloadingCity = document.getElementById('tender-unloading-city').value;
            const unloadingZip = document.getElementById('tender-unloading-zip').value;
            const price = document.getElementById('tender-price').value;
            const driver = document.getElementById('tender-driver').value;
            const status = document.getElementById('tender-status').value;
            const subStatus = document.getElementById('tender-substatus').value || null;
            const salePrice = document.getElementById('tender-sale-price').value;
            const paymentDays = document.getElementById('tender-payment-days').value;
            const modalTitle = document.getElementById('tender-modal-title').textContent;

            if (!loadingDate || !unloadingDate || !loadingCity || !loadingZip || !unloadingCity || !unloadingZip || !price) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const { data: tenders, sha } = await readFile(FILE_PATHS.TENDERS) || { data: [], sha: null };
                const now = new Date().toISOString();

                let updatedTenders;
                if (modalTitle === 'Add Tender') {
                    // Add new tender
                    const newTender = {
                        id: generateId(),
                        loading: {
                            date: loadingDate,
                            city: loadingCity,
                            zip: loadingZip
                        },
                        unloading: {
                            date: unloadingDate,
                            city: unloadingCity,
                            zip: unloadingZip
                        },
                        price: parseFloat(price),
                        driver: driver,
                        status: status,
                        subStatus: subStatus,
                        sale: status === getTenderStatuses().find(s => s.name === 'Sold').id ? {
                            price: salePrice ? parseFloat(salePrice) : 0,
                            paymentDays: parseInt(paymentDays),
                            soldAt: now
                        } : null,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedTenders = [...tenders, newTender];
                } else {
                    // Update existing tender
                    const tenderId = document.getElementById('tender-modal').getAttribute('data-id');
                    updatedTenders = tenders.map(tender => {
                        if (tender.id === tenderId) {
                            return {
                                ...tender,
                                loading: {
                                    date: loadingDate,
                                    city: loadingCity,
                                    zip: loadingZip
                                },
                                unloading: {
                                    date: unloadingDate,
                                    city: unloadingCity,
                                    zip: unloadingZip
                                },
                                price: parseFloat(price),
                                driver: driver,
                                status: status,
                                subStatus: subStatus,
                                sale: status === getTenderStatuses().find(s => s.name === 'Sold').id ? {
                                    price: salePrice ? parseFloat(salePrice) : 0,
                                    paymentDays: parseInt(paymentDays),
                                    soldAt: now
                                } : null,
                                updatedAt: now
                            };
                        }
                        return tender;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.TENDERS,
                    modalTitle === 'Add Tender' ? 'Add tender' : 'Update tender',
                    utf8ToBase64(JSON.stringify(updatedTenders, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.tenders = { 
                    data: updatedTenders, 
                    sha: result.content.sha 
                };
                closeModal();
                renderTenders();
                addNotification('Tender saved successfully', 'success');
                
                // Update driver status if driver changed
                if (driver) {
                    updateDriverStatus(driver);
                }
            } catch (error) {
                addNotification('Failed to save tender: ' + error.message, 'error');
                console.error('Save tender error:', error);
            }
        }

        async function saveInvoice() {
            const code = document.getElementById('invoice-code').value;
            const client = document.getElementById('invoice-client').value;
            const date = document.getElementById('invoice-date').value;
            const dueDays = document.getElementById('invoice-due-days').value;
            const notify = document.getElementById('invoice-notify').value;
            const reminder = document.getElementById('invoice-reminder').value;
            const status = document.getElementById('invoice-status').value;
            const modalTitle = document.getElementById('invoice-modal-title').textContent;

            if (!code || !client || !date || !dueDays) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const { data: invoices, sha } = await readFile(FILE_PATHS.INVOICES) || { data: [], sha: null };
                const now = new Date().toISOString();
                const dueDate = new Date(date);
                dueDate.setDate(dueDate.getDate() + parseInt(dueDays));

                let updatedInvoices;
                if (modalTitle === 'Add Invoice') {
                    // Add new invoice
                    const newInvoice = {
                        id: generateId(),
                        code: code,
                        client: client,
                        date: date,
                        dueDays: parseInt(dueDays),
                        dueDate: dueDate.toISOString().split('T')[0],
                        notify: parseInt(notify),
                        reminder: parseInt(reminder),
                        status: status,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedInvoices = [...invoices, newInvoice];
                } else {
                    // Update existing invoice
                    const invoiceId = document.getElementById('invoice-modal').getAttribute('data-id');
                    updatedInvoices = invoices.map(invoice => {
                        if (invoice.id === invoiceId) {
                            return {
                                ...invoice,
                                code: code,
                                client: client,
                                date: date,
                                dueDays: parseInt(dueDays),
                                dueDate: dueDate.toISOString().split('T')[0],
                                notify: parseInt(notify),
                                reminder: parseInt(reminder),
                                status: status,
                                updatedAt: now
                            };
                        }
                        return invoice;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.INVOICES,
                    modalTitle === 'Add Invoice' ? 'Add invoice' : 'Update invoice',
                    utf8ToBase64(JSON.stringify(updatedInvoices, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.invoices = { 
                    data: updatedInvoices, 
                    sha: result.content.sha 
                };
                closeModal();
                renderInvoices();
                addNotification('Invoice saved successfully', 'success');
            } catch (error) {
                addNotification('Failed to save invoice: ' + error.message, 'error');
                console.error('Save invoice error:', error);
            }
        }

        async function saveUser() {
            const name = document.getElementById('user-name-input').value;
            const lastname = document.getElementById('user-lastname').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const status = document.getElementById('user-status').value;
            const supervisor = document.getElementById('user-supervisor').value;
            const modalTitle = document.getElementById('user-modal-title').textContent;

            if (!name || !lastname || !email || !password) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                addNotification('Please enter a valid email address', 'error');
                return;
            }

            try {
                const { data: users, sha } = await readFile(FILE_PATHS.USERS) || { data: [], sha: null };
                const now = new Date().toISOString();

                let updatedUsers;
                if (modalTitle === 'Add User') {
                    // Check if user already exists
                    if (users.some(u => u.email === email)) {
                        addNotification('User with this email already exists', 'error');
                        return;
                    }

                    // Add new user
                    const newUser = {
                        id: generateId(),
                        name: name,
                        lastname: lastname,
                        email: email,
                        password: password,
                        status: status,
                        supervisor: supervisor || null,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedUsers = [...users, newUser];
                } else {
                    // Update existing user
                    const userId = document.getElementById('user-modal').getAttribute('data-id');
                    updatedUsers = users.map(user => {
                        if (user.id === userId) {
                            return {
                                ...user,
                                name: name,
                                lastname: lastname,
                                email: email,
                                password: password,
                                status: status,
                                supervisor: supervisor || null,
                                updatedAt: now
                            };
                        }
                        return user;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.USERS,
                    modalTitle === 'Add User' ? 'Add user' : 'Update user',
                    utf8ToBase64(JSON.stringify(updatedUsers, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.users = { 
                    data: updatedUsers, 
                    sha: result.content.sha 
                };
                closeModal();
                renderAdmin();
                addNotification('User saved successfully', 'success');
            } catch (error) {
                addNotification('Failed to save user: ' + error.message, 'error');
                console.error('Save user error:', error);
            }
        }

        async function saveStatus() {
            const name = document.getElementById('status-name').value;
            const type = document.getElementById('status-type').value;
            const isPrimary = document.getElementById('status-is-primary').value === 'true';
            const parentStatusId = isPrimary ? null : document.getElementById('status-parent').value;
            const color = document.getElementById('status-color').value;
            const modalTitle = document.getElementById('status-modal-title').textContent;

            if (!name || !type) {
                addNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const { data: statuses, sha } = await readFile(FILE_PATHS.STATUSES) || { data: [], sha: null };
                const now = new Date().toISOString();

                let updatedStatuses;
                if (modalTitle === 'Add Status') {
                    // Add new status
                    const newStatus = {
                        id: generateId(),
                        name: name,
                        type: type,
                        color: color,
                        isPrimary: isPrimary,
                        parentStatusId: parentStatusId,
                        createdAt: now,
                        updatedAt: now
                    };
                    updatedStatuses = [...statuses, newStatus];
                } else {
                    // Update existing status
                    const statusId = document.getElementById('status-modal').getAttribute('data-id');
                    updatedStatuses = statuses.map(status => {
                        if (status.id === statusId) {
                            return {
                                ...status,
                                name: name,
                                type: type,
                                color: color,
                                isPrimary: isPrimary,
                                parentStatusId: parentStatusId,
                                updatedAt: now
                            };
                        }
                        return status;
                    });
                }

                // Save to GitHub
                const result = await updateFile(
                    FILE_PATHS.STATUSES,
                    modalTitle === 'Add Status' ? 'Add status' : 'Update status',
                    utf8ToBase64(JSON.stringify(updatedStatuses, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.statuses = { 
                    data: updatedStatuses, 
                    sha: result.content.sha 
                };
                
                // Re-render statuses
                renderStatuses();
                
                closeModal();
                addNotification('Status saved successfully', 'success');
            } catch (error) {
                addNotification('Failed to save status: ' + error.message, 'error');
                console.error('Save status error:', error);
            }
        }

        // Status hierarchy functions
        function updateStatusHierarchy(statusId, targetStatusId, statusType) {
            const status = getStatusById(statusId);
            const targetStatus = getStatusById(targetStatusId);
            
            if (!status || !targetStatus || status.type !== statusType || targetStatus.type !== statusType) {
                return;
            }
            
            // Update the status to be a sub-status of the target
            const now = new Date().toISOString();
            state.statuses.data = state.statuses.data.map(s => {
                if (s.id === statusId) {
                    return {
                        ...s,
                        isPrimary: false,
                        parentStatusId: targetStatusId,
                        updatedAt: now
                    };
                }
                return s;
            });
            
            // Save to GitHub
            saveStatusHierarchy();
        }

        async function saveStatusHierarchy() {
            try {
                const { sha } = await readFile(FILE_PATHS.STATUSES);
                const result = await updateFile(
                    FILE_PATHS.STATUSES,
                    'Update status hierarchy',
                    utf8ToBase64(JSON.stringify(state.statuses.data, null, 2)),
                    sha
                );
                
                state.statuses.sha = result.content.sha;
                renderStatuses();
                addNotification('Status hierarchy updated', 'success');
            } catch (error) {
                addNotification('Failed to update status hierarchy: ' + error.message, 'error');
                console.error('Status hierarchy error:', error);
            }
        }

        // Delete operations
        async function deleteDriver(id) {
            if (!confirm('Are you sure you want to delete this driver?')) {
                return;
            }

            try {
                const { data: drivers, sha } = await readFile(FILE_PATHS.DRIVERS) || { data: [], sha: null };
                const updatedDrivers = drivers.filter(driver => driver.id !== id);

                const result = await updateFile(
                    FILE_PATHS.DRIVERS,
                    'Delete driver',
                    utf8ToBase64(JSON.stringify(updatedDrivers, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.drivers = { 
                    data: updatedDrivers, 
                    sha: result.content.sha 
                };
                renderDrivers();
                addNotification('Driver deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete driver: ' + error.message, 'error');
                console.error('Delete driver error:', error);
            }
        }

        async function deleteCar(id) {
            if (!confirm('Are you sure you want to delete this car?')) {
                return;
            }

            try {
                const { data: carsData, sha } = await readFile(FILE_PATHS.CARS) || { 
                    data: { 
                        data: [], 
                        carTypes: [] 
                    }, 
                    sha: null 
                };
                const updatedCars = carsData.data.filter(car => car.id !== id);

                const result = await updateFile(
                    FILE_PATHS.CARS,
                    'Delete car',
                    utf8ToBase64(JSON.stringify({
                        ...carsData,
                        data: updatedCars
                    }, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.cars = { 
                    data: {
                        ...carsData,
                        data: updatedCars
                    }, 
                    sha: result.content.sha 
                };
                renderCars();
                addNotification('Car deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete car: ' + error.message, 'error');
                console.error('Delete car error:', error);
            }
        }

        async function deleteCarType(id) {
            if (!confirm('Are you sure you want to delete this vehicle type?')) {
                return;
            }

            try {
                const { data: carsData, sha } = await readFile(FILE_PATHS.CARS) || { 
                    data: { 
                        data: [], 
                        carTypes: [] 
                    }, 
                    sha: null 
                };
                
                const updatedCarTypes = carsData.carTypes.filter(carType => carType.id !== id);

                const result = await updateFile(
                    FILE_PATHS.CARS,
                    'Delete vehicle type',
                    utf8ToBase64(JSON.stringify({
                        ...carsData,
                        carTypes: updatedCarTypes
                    }, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.cars = { 
                    data: {
                        ...carsData,
                        carTypes: updatedCarTypes
                    }, 
                    sha: result.content.sha 
                };
                renderCarTypes();
                addNotification('Vehicle type deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete vehicle type: ' + error.message, 'error');
                console.error('Delete vehicle type error:', error);
            }
        }

        async function deleteCard(id) {
            if (!confirm('Are you sure you want to delete this card?')) {
                return;
            }

            try {
                const { data: cards, sha } = await readFile(FILE_PATHS.CARDS) || { data: [], sha: null };
                const updatedCards = cards.filter(card => card.id !== id);

                const result = await updateFile(
                    FILE_PATHS.CARDS,
                    'Delete card',
                    utf8ToBase64(JSON.stringify(updatedCards, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.cards = { 
                    data: updatedCards, 
                    sha: result.content.sha 
                };
                renderCards();
                addNotification('Card deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete card: ' + error.message, 'error');
                console.error('Delete card error:', error);
            }
        }

        async function deleteTender(id) {
            if (!confirm('Are you sure you want to delete this tender?')) {
                return;
            }

            try {
                const { data: tenders, sha } = await readFile(FILE_PATHS.TENDERS) || { data: [], sha: null };
                const updatedTenders = tenders.filter(tender => tender.id !== id);

                const result = await updateFile(
                    FILE_PATHS.TENDERS,
                    'Delete tender',
                    utf8ToBase64(JSON.stringify(updatedTenders, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.tenders = { 
                    data: updatedTenders, 
                    sha: result.content.sha 
                };
                renderTenders();
                addNotification('Tender deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete tender: ' + error.message, 'error');
                console.error('Delete tender error:', error);
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice?')) {
                return;
            }

            try {
                const { data: invoices, sha } = await readFile(FILE_PATHS.INVOICES) || { data: [], sha: null };
                const updatedInvoices = invoices.filter(invoice => invoice.id !== id);

                const result = await updateFile(
                    FILE_PATHS.INVOICES,
                    'Delete invoice',
                    utf8ToBase64(JSON.stringify(updatedInvoices, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.invoices = { 
                    data: updatedInvoices, 
                    sha: result.content.sha 
                };
                renderInvoices();
                addNotification('Invoice deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete invoice: ' + error.message, 'error');
                console.error('Delete invoice error:', error);
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                const { data: users, sha } = await readFile(FILE_PATHS.USERS) || { data: [], sha: null };
                const updatedUsers = users.filter(user => user.id !== id);

                const result = await updateFile(
                    FILE_PATHS.USERS,
                    'Delete user',
                    utf8ToBase64(JSON.stringify(updatedUsers, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.users = { 
                    data: updatedUsers, 
                    sha: result.content.sha 
                };
                renderAdmin();
                addNotification('User deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete user: ' + error.message, 'error');
                console.error('Delete user error:', error);
            }
        }

        async function deleteStatus(id) {
            if (!confirm('Are you sure you want to delete this status?')) {
                return;
            }

            try {
                const { data: statuses, sha } = await readFile(FILE_PATHS.STATUSES) || { data: [], sha: null };
                const updatedStatuses = statuses.filter(status => status.id !== id);

                const result = await updateFile(
                    FILE_PATHS.STATUSES,
                    'Delete status',
                    utf8ToBase64(JSON.stringify(updatedStatuses, null, 2)),
                    sha
                );

                // Update local state with new SHA
                state.statuses = { 
                    data: updatedStatuses, 
                    sha: result.content.sha 
                };
                renderStatuses();
                addNotification('Status deleted successfully', 'success');
            } catch (error) {
                addNotification('Failed to delete status: ' + error.message, 'error');
                console.error('Delete status error:', error);
            }
        }

        // Render functions
        function renderDashboard() {
            updateDashboardStats();
            checkExpirations();
            loadRecentActivity();
        }

        function updateDashboardStats() {
            // Active drivers (drivers with status Active)
            const activeStatus = getDriverPrimaryStatuses().find(s => s.name === 'Active');
            const activeDrivers = activeStatus ? 
                state.drivers.data.filter(d => d.status === activeStatus.id).length : 0;
            document.getElementById('active-drivers').textContent = activeDrivers;

            // Active tenders
            const deliveredStatus = getTenderStatuses().find(s => s.name === 'Delivered');
            const cancelledStatus = getTenderStatuses().find(s => s.name === 'Cancelled');
            const activeTenders = state.tenders.data.filter(t => 
                t.status !== deliveredStatus.id && t.status !== cancelledStatus.id
            ).length;
            document.getElementById('active-tenders').textContent = activeTenders;

            // Monthly revenue
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthlyRevenue = state.tenders.data
                .filter(t => {
                    const tenderDate = new Date(t.loading.date);
                    return tenderDate.getMonth() === currentMonth && 
                           tenderDate.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + t.price, 0);
            
            document.getElementById('monthly-revenue').textContent = '$' + monthlyRevenue.toLocaleString();

            // Pending invoices
            const pendingStatus = getInvoiceStatuses().find(s => s.name === 'Pending');
            const unpaidStatus = getInvoiceStatuses().find(s => s.name === 'Unpaid');
            const overdueStatus = getInvoiceStatuses().find(s => s.name === 'Overdue');
            
            const pendingInvoices = state.invoices.data.filter(i => 
                i.status === pendingStatus.id || 
                i.status === unpaidStatus.id || 
                i.status === overdueStatus.id
            ).length;
            document.getElementById('pending-invoices').textContent = pendingInvoices;
        }

        function checkExpirations() {
            const expirationsList = document.getElementById('expirations-list');
            expirationsList.innerHTML = '';

            const now = new Date();
            let hasExpirations = false;

            // Check car insurance
            if (state.cars.data && state.cars.data.data) {
                state.cars.data.data.forEach(car => {
                    const insuranceDate = new Date(car.insurance);
                    const notifyDays = car.insuranceNotify || 30;
                    const diffTime = insuranceDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= notifyDays && diffDays > 0) {
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>${car.tractor}</strong> insurance expires in ${diffDays} days
                            <span class="badge status-pending" style="float: right;">${diffDays} days</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    } else if (diffDays <= 0) {
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>${car.tractor}</strong> insurance has expired!
                            <span class="badge status-danger" style="float: right;">Expired</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    }
                });
            }

            // Check car inspection
            if (state.cars.data && state.cars.data.data) {
                state.cars.data.data.forEach(car => {
                    const inspectionDate = new Date(car.inspection);
                    const notifyDays = car.inspectionNotify || 30;
                    const diffTime = inspectionDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= notifyDays && diffDays > 0) {
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>${car.tractor}</strong> inspection due in ${diffDays} days
                            <span class="badge status-pending" style="float: right;">${diffDays} days</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    } else if (diffDays <= 0) {
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>${car.tractor}</strong> inspection has expired!
                            <span class="badge status-danger" style="float: right;">Expired</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    }
                });
            }

            // Check card expiry
            if (state.cards.data) {
                state.cards.data.forEach(card => {
                    const expiryDate = new Date(card.expiry);
                    const notifyDays = card.notify || 30;
                    const diffTime = expiryDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays <= notifyDays && diffDays > 0) {
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>Card ${card.number}</strong> expires in ${diffDays} days
                            <span class="badge status-pending" style="float: right;">${diffDays} days</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    } else if (diffDays <= 0) {
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>Card ${card.number}</strong> has expired!
                            <span class="badge status-danger" style="float: right;">Expired</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    }
                });
            }

            // Check invoice due dates
            const nowStr = now.toISOString().split('T')[0];
            if (state.invoices.data) {
                state.invoices.data.forEach(invoice => {
                    if (invoice.dueDate < nowStr) {
                        const diffDays = Math.ceil((now - new Date(invoice.dueDate)) / (1000 * 60 * 60 * 24));
                        
                        const li = document.createElement('li');
                        li.className = 'mb-2';
                        li.innerHTML = `
                            <strong>Invoice ${invoice.code}</strong> is overdue by ${diffDays} days
                            <span class="badge status-danger" style="float: right;">Overdue</span>
                        `;
                        expirationsList.appendChild(li);
                        hasExpirations = true;
                    }
                });
            }

            if (!hasExpirations) {
                const li = document.createElement('li');
                li.textContent = 'No upcoming expirations';
                expirationsList.appendChild(li);
            }
        }

        function loadRecentActivity() {
            const activityList = document.getElementById('recent-activity');
            activityList.innerHTML = '';

            // Get latest activities from all data types
            const activities = [];

            // Add recent drivers
            if (state.drivers.data) {
                const recentDrivers = [...state.drivers.data]
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, 3);
                
                recentDrivers.forEach(driver => {
                    activities.push({
                        type: 'driver',
                        action: driver.createdAt === driver.updatedAt ? 'created' : 'updated',
                        name: `${driver.name} ${driver.lastname}`,
                        time: driver.updatedAt
                    });
                });
            }

            // Add recent tenders
            if (state.tenders.data) {
                const recentTenders = [...state.tenders.data]
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, 3);
                
                recentTenders.forEach(tender => {
                    activities.push({
                        type: 'tender',
                        action: tender.createdAt === tender.updatedAt ? 'created' : 'updated',
                        name: `${tender.loading.city} → ${tender.unloading.city}`,
                        time: tender.updatedAt
                    });
                });
            }

            // Sort by time and get latest 5
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            const latestActivities = activities.slice(0, 5);

            if (latestActivities.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No recent activity';
                activityList.appendChild(li);
            } else {
                latestActivities.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'mb-2';
                    const timeAgo = getTimeAgo(activity.time);
                    li.innerHTML = `
                        <strong>${activity.name}</strong> ${activity.action} (${activity.type})
                        <span class="text-muted" style="float: right;">${timeAgo}</span>
                    `;
                    activityList.appendChild(li);
                });
            }
        }

        function renderDrivers() {
            const tableBody = document.getElementById('drivers-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (!state.drivers.data || state.drivers.data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" class="text-center">No drivers found</td>';
                tableBody.appendChild(row);
                return;
            }

            // Populate car and card select options
            const carSelect = document.getElementById('driver-car');
            const cardSelect = document.getElementById('driver-card');
            
            if (carSelect) {
                carSelect.innerHTML = '<option value="">Select Car</option>';
                if (state.cars.data && state.cars.data.data) {
                    state.cars.data.data.forEach(car => {
                        const option = document.createElement('option');
                        option.value = car.id;
                        option.textContent = `${car.tractor} / ${car.trailer}`;
                        carSelect.appendChild(option);
                    });
                }
            }
            
            if (cardSelect) {
                cardSelect.innerHTML = '<option value="">Select Card</option>';
                if (state.cards.data) {
                    state.cards.data.forEach(card => {
                        const option = document.createElement('option');
                        option.value = card.id;
                        option.textContent = card.number;
                        cardSelect.appendChild(option);
                    });
                }
            }

            state.drivers.data.forEach(driver => {
                const row = document.createElement('tr');
                
                // Find car and card details
                let car = {};
                let card = {};
                
                if (state.cars.data && state.cars.data.data) {
                    car = state.cars.data.data.find(c => c.id === driver.car) || {};
                }
                
                if (state.cards.data) {
                    card = state.cards.data.find(c => c.id === driver.card) || {};
                }
                
                // Get status names
                const primaryStatus = driver.status ? getStatusById(driver.status) : null;
                const subStatus = driver.subStatus ? getStatusById(driver.subStatus) : null;
                
                row.innerHTML = `
                    <td>${driver.name} ${driver.lastname}</td>
                    <td>${car.tractor || 'Not assigned'}</td>
                    <td>${card.number || 'Not assigned'}</td>
                    <td><span class="status-badge ${primaryStatus ? getStatusColorClass(primaryStatus) : 'status-inactive'}">${primaryStatus ? primaryStatus.name : 'Unknown'}</span></td>
                    <td><span class="status-badge ${subStatus ? getStatusColorClass(subStatus) : ''}">${subStatus ? subStatus.name : ''}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-driver" data-id="${driver.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-driver" data-id="${driver.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-driver').forEach(btn => {
                btn.addEventListener('click', function() {
                    editDriver(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-driver').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteDriver(this.getAttribute('data-id'));
                });
            });
        }

        function renderCars() {
            const tableBody = document.getElementById('cars-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (!state.cars.data || !state.cars.data.data || state.cars.data.data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" class="text-center">No cars found</td>';
                tableBody.appendChild(row);
                return;
            }

            // Populate car type select options
            const carTypeSelect = document.getElementById('car-type');
            if (carTypeSelect) {
                carTypeSelect.innerHTML = '<option value="">Select Type</option>';
                
                if (state.cars.data && state.cars.data.carTypes) {
                    state.cars.data.carTypes.forEach(carType => {
                        const option = document.createElement('option');
                        option.value = carType.id;
                        option.textContent = carType.name;
                        carTypeSelect.appendChild(option);
                    });
                }
            }

            // Populate status select options
            const carStatusSelect = document.getElementById('car-status');
            if (carStatusSelect) {
                carStatusSelect.innerHTML = '<option value="">Select Status</option>';
                
                getCarStatuses().forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    carStatusSelect.appendChild(option);
                });
            }

            state.cars.data.data.forEach(car => {
                const row = document.createElement('tr');
                
                const insuranceDate = new Date(car.insurance);
                const inspectionDate = new Date(car.inspection);
                const now = new Date();
                
                const insuranceDiff = Math.ceil((insuranceDate - now) / (1000 * 60 * 60 * 24));
                const inspectionDiff = Math.ceil((inspectionDate - now) / (1000 * 60 * 60 * 24));
                
                const insuranceStatus = insuranceDiff <= 0 ? 'danger' : 
                                      insuranceDiff <= (car.insuranceNotify || 30) ? 'warning' : 'active';
                
                const inspectionStatus = inspectionDiff <= 0 ? 'danger' : 
                                       inspectionDiff <= (car.inspectionNotify || 30) ? 'warning' : 'active';
                
                // Get car type details
                const carType = car.carType ? getCarTypeById(car.carType) : null;
                
                // Calculate total max weight
                let totalMaxWeight = 0;
                if (carType) {
                    totalMaxWeight = carType.mainMaxWeight;
                    if (carType.isTandem) {
                        totalMaxWeight += carType.trailerMaxWeight;
                    }
                }
                
                // Calculate cubic capacity
                let cubicCapacity = 0;
                if (carType) {
                    const mainCubic = carType.mainDimensions.length * 
                                     carType.mainDimensions.width * 
                                     carType.mainDimensions.height;
                    
                    let trailerCubic = 0;
                    if (carType.isTandem && carType.trailerDimensions) {
                        trailerCubic = carType.trailerDimensions.length * 
                                      carType.trailerDimensions.width * 
                                      carType.trailerDimensions.height;
                    }
                    
                    cubicCapacity = mainCubic + trailerCubic;
                }

                row.innerHTML = `
                    <td>${car.tractor}</td>
                    <td>${car.trailer}</td>
                    <td>${carType ? carType.name : 'Custom'}</td>
                    <td>${cubicCapacity.toFixed(2)} m³</td>
                    <td>${totalMaxWeight.toFixed(1)} tons</td>
                    <td>
                        ${car.insurance}
                        <span class="status-badge status-${insuranceStatus}">${insuranceDiff > 0 ? insuranceDiff + ' days' : 'Expired'}</span>
                    </td>
                    <td>
                        ${car.inspection}
                        <span class="status-badge status-${inspectionStatus}">${inspectionDiff > 0 ? inspectionDiff + ' days' : 'Expired'}</span>
                    </td>
                    <td><span class="status-badge status-${getStatusColorClass(getStatusById(car.status))}">${getStatusById(car.status)?.name || 'Unknown'}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-car" data-id="${car.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-car" data-id="${car.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-car').forEach(btn => {
                btn.addEventListener('click', function() {
                    editCar(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-car').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteCar(this.getAttribute('data-id'));
                });
            });
        }

        function renderCards() {
            const tableBody = document.getElementById('cards-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (!state.cards.data || state.cards.data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No cards found</td>';
                tableBody.appendChild(row);
                return;
            }

            // Populate status select options
            const cardStatusSelect = document.getElementById('card-status');
            if (cardStatusSelect) {
                cardStatusSelect.innerHTML = '<option value="">Select Status</option>';
                
                getCardStatuses().forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    cardStatusSelect.appendChild(option);
                });
            }

            state.cards.data.forEach(card => {
                const row = document.createElement('tr');
                
                const expiryDate = new Date(card.expiry);
                const now = new Date();
                const diff = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                
                const status = diff <= 0 ? 'danger' : 
                             diff <= (card.notify || 30) ? 'warning' : 'active';

                row.innerHTML = `
                    <td>${card.number}</td>
                    <td>${card.pin}</td>
                    <td>${card.expiry}</td>
                    <td><span class="status-badge status-${status}">${diff > 0 ? diff + ' days' : 'Expired'}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-card" data-id="${card.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-card" data-id="${card.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-card').forEach(btn => {
                btn.addEventListener('click', function() {
                    editCard(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-card').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteCard(this.getAttribute('data-id'));
                });
            });
        }

        function renderTenders() {
            const tableBody = document.getElementById('tenders-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (!state.tenders.data || state.tenders.data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No tenders found</td>';
                tableBody.appendChild(row);
                return;
            }

            // Populate driver select options
            const driverSelect = document.getElementById('tender-driver');
            if (driverSelect) {
                driverSelect.innerHTML = '<option value="">Select Driver</option>';
                
                if (state.drivers.data) {
                    state.drivers.data.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.id;
                        option.textContent = `${driver.name} ${driver.lastname}`;
                        driverSelect.appendChild(option);
                    });
                }
            }

            // Populate status select options
            const statusSelect = document.getElementById('tender-status');
            if (statusSelect) {
                statusSelect.innerHTML = '<option value="">Select Status</option>';
                
                getTenderStatuses().forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    statusSelect.appendChild(option);
                });
            }

            state.tenders.data.forEach(tender => {
                const row = document.createElement('tr');
                
                // Find driver details
                let driver = {};
                if (state.drivers.data) {
                    driver = state.drivers.data.find(d => d.id === tender.driver) || {};
                }
                
                // Get status names
                const status = getStatusById(tender.status);
                const subStatus = tender.subStatus ? getStatusById(tender.subStatus) : null;
                
                row.innerHTML = `
                    <td>
                        ${tender.loading.city}<br>
                        <small>${new Date(tender.loading.date).toLocaleString()}</small>
                    </td>
                    <td>
                        ${tender.unloading.city}<br>
                        <small>${new Date(tender.unloading.date).toLocaleString()}</small>
                    </td>
                    <td>$${tender.price.toLocaleString()}</td>
                    <td>${driver.name ? `${driver.name} ${driver.lastname}` : 'Not assigned'}</td>
                    <td><span class="status-badge ${status ? getStatusColorClass(status) : 'status-inactive'}">${status ? status.name : 'Unknown'}</span></td>
                    <td><span class="status-badge ${subStatus ? getStatusColorClass(subStatus) : ''}">${subStatus ? subStatus.name : ''}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-tender" data-id="${tender.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-tender" data-id="${tender.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-tender').forEach(btn => {
                btn.addEventListener('click', function() {
                    editTender(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-tender').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteTender(this.getAttribute('data-id'));
                });
            });
        }

        function renderInvoices() {
            const tableBody = document.getElementById('invoices-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (!state.invoices.data || state.invoices.data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" class="text-center">No invoices found</td>';
                tableBody.appendChild(row);
                return;
            }

            // Populate status select options
            const invoiceStatusSelect = document.getElementById('invoice-status');
            if (invoiceStatusSelect) {
                invoiceStatusSelect.innerHTML = '<option value="">Select Status</option>';
                
                getInvoiceStatuses().forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    invoiceStatusSelect.appendChild(option);
                });
            }

            state.invoices.data.forEach(invoice => {
                const row = document.createElement('tr');
                
                const dueDate = new Date(invoice.dueDate);
                const now = new Date();
                const diff = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                
                const status = getStatusById(invoice.status);
                const statusClass = status ? getStatusColorClass(status) : 'status-inactive';

                row.innerHTML = `
                    <td>${invoice.code}</td>
                    <td>${invoice.client}</td>
                    <td>${invoice.date}</td>
                    <td>${invoice.dueDate} (${diff} days)</td>
                    <td><span class="status-badge ${statusClass}">${status ? status.name : 'Unknown'}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-invoice" data-id="${invoice.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-invoice" data-id="${invoice.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-invoice').forEach(btn => {
                btn.addEventListener('click', function() {
                    editInvoice(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-invoice').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteInvoice(this.getAttribute('data-id'));
                });
            });
        }

        function renderReports() {
            // Revenue chart
            const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Revenue',
                         [12000, 19000, 15000, 20000, 25000, 30000, 35000, 40000, 38000, 36000, 32000, 45000],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Loading chart
            const loadingCtx = document.getElementById('loading-chart').getContext('2d');
            new Chart(loadingCtx, {
                type: 'bar',
                 {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: '% Loading',
                        data: [75, 80, 70, 85, 90, 88, 92, 95, 87, 83, 80, 93],
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Revenue breakdown chart
            const breakdownCtx = document.getElementById('revenue-breakdown-chart').getContext('2d');
            new Chart(breakdownCtx, {
                type: 'pie',
                 {
                    labels: ['Domestic', 'International', 'Express', 'Special'],
                    datasets: [{
                        data: [45, 30, 15, 10],
                        backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12']
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Top drivers
            const topDrivers = document.getElementById('top-drivers');
            if (topDrivers) {
                topDrivers.innerHTML = '';
                
                const sortedDrivers = [...(state.drivers.data || [])]
                    .sort(() => Math.random() - 0.5) // Random sorting for demo
                    .slice(0, 5);
                
                sortedDrivers.forEach((driver, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div>
                            <strong>#${index + 1} ${driver.name} ${driver.lastname}</strong><br>
                            <small>$${Math.floor(Math.random() * 10000) + 5000} revenue</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${Math.floor(Math.random() * 20) + 10} trips</span>
                    `;
                    topDrivers.appendChild(li);
                });
            }
        }

        function renderStatuses(filterType = 'all') {
            // Render driver statuses
            const driverHierarchy = document.getElementById('driver-status-hierarchy');
            if (driverHierarchy) {
                driverHierarchy.innerHTML = '';
                
                const driverPrimaryStatuses = getDriverPrimaryStatuses();
                driverPrimaryStatuses.forEach(primaryStatus => {
                    const item = document.createElement('div');
                    item.className = 'status-hierarchy-item';
                    item.dataset.statusId = primaryStatus.id;
                    item.draggable = true;
                    
                    const subStatuses = getDriverSubStatuses(primaryStatus.id);
                    
                    item.innerHTML = `
                        <div>
                            <span class="status-badge ${getStatusColorClass(primaryStatus)}">${primaryStatus.name}</span>
                            ${subStatuses.length > 0 ? 
                                `<div class="status-hierarchy" style="margin-left: 20px; margin-top: 5px;">
                                    ${subStatuses.map(subStatus => `
                                        <div class="status-hierarchy-item" data-status-id="${subStatus.id}" draggable="true">
                                            <span class="status-badge ${getStatusColorClass(subStatus)}">${subStatus.name}</span>
                                        </div>
                                    `).join('')}
                                </div>` : ''}
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm edit-status" data-id="${primaryStatus.id}">Edit</button>
                            <button class="btn btn-danger btn-sm delete-status" data-id="${primaryStatus.id}">Delete</button>
                        </div>
                    `;
                    
                    driverHierarchy.appendChild(item);
                });
                
                // Add event listeners for driver statuses
                document.querySelectorAll('.edit-status').forEach(btn => {
                    btn.addEventListener('click', function() {
                        editStatus(this.getAttribute('data-id'));
                    });
                });

                document.querySelectorAll('.delete-status').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deleteStatus(this.getAttribute('data-id'));
                    });
                });
            }
            
            // Render car statuses
            const carHierarchy = document.getElementById('car-status-hierarchy');
            if (carHierarchy) {
                carHierarchy.innerHTML = '';
                
                const carStatuses = getCarStatuses();
                carStatuses.forEach(status => {
                    const item = document.createElement('div');
                    item.className = 'status-hierarchy-item';
                    item.dataset.statusId = status.id;
                    item.draggable = true;
                    
                    item.innerHTML = `
                        <span class="status-badge ${getStatusColorClass(status)}">${status.name}</span>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm edit-status" data-id="${status.id}">Edit</button>
                            <button class="btn btn-danger btn-sm delete-status" data-id="${status.id}">Delete</button>
                        </div>
                    `;
                    
                    carHierarchy.appendChild(item);
                });
                
                // Add event listeners for car statuses
                document.querySelectorAll('.edit-status').forEach(btn => {
                    btn.addEventListener('click', function() {
                        editStatus(this.getAttribute('data-id'));
                    });
                });

                document.querySelectorAll('.delete-status').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deleteStatus(this.getAttribute('data-id'));
                    });
                });
            }
        }

        function renderCarTypes() {
            const tableBody = document.getElementById('cartypes-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            // Get car types from the merged structure
            const carTypes = state.cars.data && state.cars.data.carTypes ? state.cars.data.carTypes : [];
            
            if (carTypes.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No vehicle types found</td>';
                tableBody.appendChild(row);
                return;
            }

            carTypes.forEach(carType => {
                const row = document.createElement('tr');
                
                // Calculate main cubic capacity
                const mainCubic = carType.mainDimensions.length * 
                                 carType.mainDimensions.width * 
                                 carType.mainDimensions.height;
                
                // Calculate trailer cubic capacity
                let trailerCubic = 0;
                if (carType.isTandem && carType.trailerDimensions) {
                    trailerCubic = carType.trailerDimensions.length * 
                                   carType.trailerDimensions.width * 
                                   carType.trailerDimensions.height;
                }
                
                // Total cubic capacity
                const totalCubic = mainCubic + trailerCubic;
                
                // Total max weight
                const totalMaxWeight = carType.mainMaxWeight + (carType.isTandem ? carType.trailerMaxWeight : 0);
                
                row.innerHTML = `
                    <td>${carType.name}</td>
                    <td>${carType.description || 'No description'}</td>
                    <td>${carType.mainDimensions.length}m x ${carType.mainDimensions.width}m x ${carType.mainDimensions.height}m</td>
                    <td>${carType.isTandem && carType.trailerDimensions ? 
                        `${carType.trailerDimensions.length}m x ${carType.trailerDimensions.width}m x ${carType.trailerDimensions.height}m` : '-'}</td>
                    <td>${totalMaxWeight.toFixed(1)} tons (${carType.mainMaxWeight.toFixed(1)} + ${carType.isTandem ? carType.trailerMaxWeight.toFixed(1) : '0'} tons)</td>
                    <td>${carType.isTandem ? 'Yes' : 'No'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-cartype" data-id="${carType.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-cartype" data-id="${carType.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-cartype').forEach(btn => {
                btn.addEventListener('click', function() {
                    editCarType(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-cartype').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteCarType(this.getAttribute('data-id'));
                });
            });
        }

        function renderAdmin() {
            // Users tab
            const usersTableBody = document.getElementById('users-table-body');
            if (!usersTableBody) return;
            
            usersTableBody.innerHTML = '';

            // Check if data is null or undefined
            if (!state.users.data || state.users.data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="text-center">No users found</td>';
                usersTableBody.appendChild(row);
                return;
            }

            // Populate supervisor select
            const supervisorSelect = document.getElementById('user-supervisor');
            if (supervisorSelect) {
                supervisorSelect.innerHTML = '<option value="">None</option>';
                
                state.users.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} ${user.lastname}`;
                    supervisorSelect.appendChild(option);
                });
            }

            state.users.data.forEach(user => {
                const row = document.createElement('tr');
                
                // Find supervisor
                const supervisor = state.users.data.find(u => u.id === user.supervisor) || {};
                
                row.innerHTML = `
                    <td>${user.name} ${user.lastname}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge status-${getStatusColor(user.status)}">${user.status}</span></td>
                    <td>${supervisor.name ? `${supervisor.name} ${supervisor.lastname}` : 'None'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm edit-user" data-id="${user.id}">Edit</button>
                        <button class="btn btn-danger btn-sm delete-user" data-id="${user.id}">Delete</button>
                    </td>
                `;
                
                usersTableBody.appendChild(row);
            });

            // Add event listeners
            document.querySelectorAll('.edit-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    editUser(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-user').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteUser(this.getAttribute('data-id'));
                });
            });

            // Build organization tree
            buildOrgTree();
            
            // Statuses tab
            renderStatuses();
            
            // Car Types tab
            renderCarTypes();
        }

        function buildOrgTree() {
            const orgTree = document.getElementById('org-tree');
            if (!orgTree) return;
            
            orgTree.innerHTML = '';

            // Find root users (those with no supervisor or supervisor not in list)
            const rootUsers = state.users.data.filter(user => 
                !user.supervisor || !state.users.data.some(u => u.id === user.supervisor)
            );

            rootUsers.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>${user.name} ${user.lastname}</strong> (${user.status})
                `;
                orgTree.appendChild(li);
                
                // Add subordinates
                const subordinates = state.users.data.filter(u => u.supervisor === user.id);
                if (subordinates.length > 0) {
                    const ul = document.createElement('ul');
                    subordinates.forEach(sub => {
                        const subLi = document.createElement('li');
                        subLi.innerHTML = `
                            ${sub.name} ${sub.lastname} (${sub.status})
                        `;
                        ul.appendChild(subLi);
                    });
                    li.appendChild(ul);
                }
            });
        }

        function renderChat() {
            const chatUsersList = document.getElementById('chat-users-list');
            if (!chatUsersList) return;
            
            chatUsersList.innerHTML = '';

            state.users.data.forEach(user => {
                if (user.id !== state.currentUser.id) {
                    const div = document.createElement('div');
                    div.className = 'chat-user';
                    div.setAttribute('data-user', user.id);
                    div.innerHTML = `
                        <strong>${user.name} ${user.lastname}</strong><br>
                        <small>${user.status}</small>
                    `;
                    chatUsersList.appendChild(div);
                }
            });

            // Add event listeners
            document.querySelectorAll('.chat-user').forEach(user => {
                user.addEventListener('click', function() {
                    document.querySelectorAll('.chat-user').forEach(u => {
                        u.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });
        }

        // Modal functions
        function openModal(type, id = null, statusType = null) {
            const modal = document.getElementById(`${type}-modal`);
            if (!modal) return;
            
            const modalTitle = document.getElementById(`${type}-modal-title`);
            
            if (id) {
                modalTitle.textContent = `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                modal.setAttribute('data-id', id);
                
                // Populate form with existing data
                if (type === 'driver') {
                    const driver = state.drivers.data.find(d => d.id === id);
                    if (!driver) return;
                    
                    document.getElementById('driver-name').value = driver.name;
                    document.getElementById('driver-lastname').value = driver.lastname;
                    document.getElementById('driver-car').value = driver.car || '';
                    document.getElementById('driver-card').value = driver.card || '';
                    document.getElementById('driver-on-break').value = driver.onBreak || 'false';
                    document.getElementById('driver-on-vacation').value = driver.onVacation || 'false';
                    document.getElementById('driver-work-hours').value = driver.workHours || '8:00-17:00';
                } else if (type === 'car') {
                    const car = state.cars.data.data.find(c => c.id === id);
                    if (!car) return;
                    
                    document.getElementById('car-tractor').value = car.tractor;
                    document.getElementById('car-trailer').value = car.trailer;
                    document.getElementById('car-type').value = car.carType || '';
                    document.getElementById('car-insurance').value = car.insurance;
                    document.getElementById('car-inspection').value = car.inspection;
                    document.getElementById('car-insurance-notify').value = car.insuranceNotify;
                    document.getElementById('car-inspection-notify').value = car.inspectionNotify;
                    document.getElementById('car-status').value = car.status || '';
                    
                    // Update car type details
                    updateCarTypeDetails(car.carType);
                } else if (type === 'card') {
                    const card = state.cards.data.find(c => c.id === id);
                    if (!card) return;
                    
                    document.getElementById('card-number').value = card.number;
                    document.getElementById('card-pin').value = card.pin;
                    document.getElementById('card-expiry').value = card.expiry;
                    document.getElementById('card-notify').value = card.notify;
                    document.getElementById('card-reminder').value = card.reminder;
                    document.getElementById('card-status').value = card.status || '';
                } else if (type === 'tender') {
                    const tender = state.tenders.data.find(t => t.id === id);
                    if (!tender) return;
                    
                    document.getElementById('tender-loading-date').value = tender.loading.date;
                    document.getElementById('tender-unloading-date').value = tender.unloading.date;
                    document.getElementById('tender-loading-city').value = tender.loading.city;
                    document.getElementById('tender-loading-zip').value = tender.loading.zip;
                    document.getElementById('tender-unloading-city').value = tender.unloading.city;
                    document.getElementById('tender-unloading-zip').value = tender.unloading.zip;
                    document.getElementById('tender-price').value = tender.price;
                    document.getElementById('tender-driver').value = tender.driver || '';
                    document.getElementById('tender-status').value = tender.status || '';
                    
                    // Populate sub-statuses based on selected status
                    populateSubStatuses(tender.status);
                    document.getElementById('tender-substatus').value = tender.subStatus || '';
                    
                    if (tender.status === getTenderStatuses().find(s => s.name === 'Sold').id) {
                        document.getElementById('tender-sale-fields').classList.remove('hidden');
                        document.getElementById('tender-sale-price').value = tender.sale.price;
                        document.getElementById('tender-payment-days').value = tender.sale.paymentDays;
                    } else {
                        document.getElementById('tender-sale-fields').classList.add('hidden');
                    }
                } else if (type === 'invoice') {
                    const invoice = state.invoices.data.find(i => i.id === id);
                    if (!invoice) return;
                    
                    document.getElementById('invoice-code').value = invoice.code;
                    document.getElementById('invoice-client').value = invoice.client;
                    document.getElementById('invoice-date').value = invoice.date;
                    document.getElementById('invoice-due-days').value = invoice.dueDays;
                    document.getElementById('invoice-notify').value = invoice.notify;
                    document.getElementById('invoice-reminder').value = invoice.reminder;
                    document.getElementById('invoice-status').value = invoice.status || '';
                } else if (type === 'user') {
                    const user = state.users.data.find(u => u.id === id);
                    if (!user) return;
                    
                    document.getElementById('user-name-input').value = user.name;
                    document.getElementById('user-lastname').value = user.lastname;
                    document.getElementById('user-email').value = user.email;
                    document.getElementById('user-password').value = user.password;
                    document.getElementById('user-status').value = user.status;
                    document.getElementById('user-supervisor').value = user.supervisor || '';
                } else if (type === 'status') {
                    const status = state.statuses.data.find(s => s.id === id);
                    if (!status) return;
                    
                    document.getElementById('status-name').value = status.name;
                    document.getElementById('status-type').value = status.type;
                    document.getElementById('status-is-primary').value = status.isPrimary ? 'true' : 'false';
                    document.getElementById('status-parent').value = status.parentStatusId || '';
                    document.getElementById('status-color').value = status.color;
                    
                    // Show/hide parent status field
                    document.getElementById('status-parent-container').style.display = 
                        status.isPrimary ? 'none' : 'block';
                    
                    // Populate parent statuses
                    populateParentStatuses(status.type);
                } else if (type === 'cartype') {
                    const carType = state.cars.data.carTypes.find(c => c.id === id);
                    if (!carType) return;
                    
                    document.getElementById('cartype-name').value = carType.name;
                    document.getElementById('cartype-description').value = carType.description || '';
                    document.getElementById('cartype-length').value = carType.mainDimensions.length;
                    document.getElementById('cartype-width').value = carType.mainDimensions.width;
                    document.getElementById('cartype-height').value = carType.mainDimensions.height;
                    document.getElementById('cartype-main-weight').value = carType.mainMaxWeight;
                    document.getElementById('cartype-is-tandem').value = carType.isTandem ? 'true' : 'false';
                    
                    // Show trailer dimensions if tandem
                    const trailerDimensions = document.getElementById('trailer-dimensions');
                    if (trailerDimensions) {
                        trailerDimensions.classList.toggle('hidden', !carType.isTandem);
                    }
                    
                    // Set trailer dimensions if available
                    if (carType.isTandem && carType.trailerDimensions) {
                        document.getElementById('cartype-trailer-length').value = carType.trailerDimensions.length;
                        document.getElementById('cartype-trailer-width').value = carType.trailerDimensions.width;
                        document.getElementById('cartype-trailer-height').value = carType.trailerDimensions.height;
                        document.getElementById('cartype-trailer-weight').value = carType.trailerMaxWeight;
                    }
                    
                    // Calculate cubic capacity and weight
                    calculateCarTypeCubicCapacity();
                    calculateCarTypeWeight();
                }
            } else {
                modalTitle.textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                modal.removeAttribute('data-id');
                
                // Clear form
                if (type === 'driver') {
                    document.getElementById('driver-name').value = '';
                    document.getElementById('driver-lastname').value = '';
                    document.getElementById('driver-car').value = '';
                    document.getElementById('driver-card').value = '';
                    document.getElementById('driver-on-break').value = 'false';
                    document.getElementById('driver-on-vacation').value = 'false';
                    document.getElementById('driver-work-hours').value = '8:00-17:00';
                } else if (type === 'car') {
                    document.getElementById('car-tractor').value = '';
                    document.getElementById('car-trailer').value = '';
                    document.getElementById('car-type').value = '';
                    document.getElementById('car-insurance').value = '';
                    document.getElementById('car-inspection').value = '';
                    document.getElementById('car-insurance-notify').value = '30';
                    document.getElementById('car-inspection-notify').value = '30';
                    document.getElementById('car-status').value = '';
                    
                    // Hide car type details
                    document.getElementById('car-type-details').classList.add('hidden');
                    document.getElementById('trailer-weight-row').style.display = 'none';
                } else if (type === 'card') {
                    document.getElementById('card-number').value = '';
                    document.getElementById('card-pin').value = '';
                    document.getElementById('card-expiry').value = '';
                    document.getElementById('card-notify').value = '30';
                    document.getElementById('card-reminder').value = '7';
                    document.getElementById('card-status').value = '';
                } else if (type === 'tender') {
                    document.getElementById('tender-loading-date').value = '';
                    document.getElementById('tender-unloading-date').value = '';
                    document.getElementById('tender-loading-city').value = '';
                    document.getElementById('tender-loading-zip').value = '';
                    document.getElementById('tender-unloading-city').value = '';
                    document.getElementById('tender-unloading-zip').value = '';
                    document.getElementById('tender-price').value = '';
                    document.getElementById('tender-driver').value = '';
                    document.getElementById('tender-status').value = '';
                    document.getElementById('tender-substatus').value = '';
                    document.getElementById('tender-sale-fields').classList.add('hidden');
                    document.getElementById('tender-sale-price').value = '';
                    document.getElementById('tender-payment-days').value = '30';
                } else if (type === 'invoice') {
                    document.getElementById('invoice-code').value = '';
                    document.getElementById('invoice-client').value = '';
                    document.getElementById('invoice-date').value = '';
                    document.getElementById('invoice-due-days').value = '30';
                    document.getElementById('invoice-notify').value = '7';
                    document.getElementById('invoice-reminder').value = '3';
                    document.getElementById('invoice-status').value = '';
                } else if (type === 'user') {
                    document.getElementById('user-name-input').value = '';
                    document.getElementById('user-lastname').value = '';
                    document.getElementById('user-email').value = '';
                    document.getElementById('user-password').value = '';
                    document.getElementById('user-status').value = 'user';
                    document.getElementById('user-supervisor').value = '';
                } else if (type === 'status') {
                    document.getElementById('status-name').value = '';
                    document.getElementById('status-type').value = statusType || 'driver';
                    document.getElementById('status-is-primary').value = 'true';
                    document.getElementById('status-parent').value = '';
                    document.getElementById('status-color').value = 'active';
                    
                    // Show/hide parent status field
                    document.getElementById('status-parent-container').style.display = 'none';
                    
                    // Populate parent statuses
                    populateParentStatuses(statusType || 'driver');
                } else if (type === 'cartype') {
                    document.getElementById('cartype-name').value = '';
                    document.getElementById('cartype-description').value = '';
                    document.getElementById('cartype-length').value = '';
                    document.getElementById('cartype-width').value = '';
                    document.getElementById('cartype-height').value = '';
                    document.getElementById('cartype-main-weight').value = '';
                    document.getElementById('cartype-is-tandem').value = 'false';
                    
                    // Hide trailer dimensions by default
                    const trailerDimensions = document.getElementById('trailer-dimensions');
                    if (trailerDimensions) {
                        trailerDimensions.classList.add('hidden');
                    }
                    
                    // Clear trailer dimensions
                    document.getElementById('cartype-trailer-length').value = '';
                    document.getElementById('cartype-trailer-width').value = '';
                    document.getElementById('cartype-trailer-height').value = '';
                    document.getElementById('cartype-trailer-weight').value = '';
                    
                    // Reset cubic capacity display
                    document.getElementById('cartype-main-cubic').textContent = '0.00 m³';
                    document.getElementById('cartype-trailer-cubic').textContent = '0.00 m³';
                    document.getElementById('cartype-total-cubic').textContent = '0.00 m³';
                    
                    // Reset weight display
                    const mainWeightDisplay = document.getElementById('cartype-main-weight-display');
                    const trailerWeightDisplay = document.getElementById('cartype-trailer-weight-display');
                    const totalWeightDisplay = document.getElementById('cartype-total-weight-display');
                    
                    if (mainWeightDisplay) mainWeightDisplay.textContent = '0.0 tons';
                    if (trailerWeightDisplay) trailerWeightDisplay.textContent = '0.0 tons';
                    if (totalWeightDisplay) totalWeightDisplay.textContent = '0.0 tons';
                    
                    // Hide trailer weight row
                    const trailerWeightRow = document.getElementById('trailer-weight-row');
                    if (trailerWeightRow) trailerWeightRow.style.display = 'none';
                }
            }
            
            modal.classList.add('show');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        // Status helper functions
        function populateParentStatuses(type) {
            const parentSelect = document.getElementById('status-parent');
            if (!parentSelect) return;
            
            parentSelect.innerHTML = '';
            
            const primaryStatuses = getPrimaryStatuses(type);
            primaryStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.id;
                option.textContent = status.name;
                parentSelect.appendChild(option);
            });
        }

        function populateSubStatuses(statusId) {
            const subStatusSelect = document.getElementById('tender-substatus');
            if (!subStatusSelect) return;
            
            subStatusSelect.innerHTML = '<option value="">Select Sub-Status</option>';
            
            const subStatuses = getSubStatuses(statusId);
            subStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.id;
                option.textContent = status.name;
                subStatusSelect.appendChild(option);
            });
        }

        // Edit functions
        function editDriver(id) {
            openModal('driver', id);
        }

        function editCar(id) {
            openModal('car', id);
        }

        function editCard(id) {
            openModal('card', id);
        }

        function editTender(id) {
            openModal('tender', id);
        }

        function editInvoice(id) {
            openModal('invoice', id);
        }

        function editUser(id) {
            openModal('user', id);
        }

        function editStatus(id) {
            openModal('status', id);
        }

        function editCarType(id) {
            openModal('cartype', id);
        }

        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getStatusColor(status) {
            const statusMap = {
                'active': 'active',
                'on-route': 'active',
                'pending': 'pending',
                'inactive': 'inactive',
                'maintenance': 'warning',
                'inspection': 'warning',
                'expired': 'danger',
                'expiring': 'warning',
                'delivered': 'completed',
                'cancelled': 'danger',
                'sold': 'success',
                'paid': 'completed',
                'unpaid': 'warning',
                'overdue': 'danger'
            };
            return statusMap[status] || 'active';
        }

        function calculateCarTypeCubicCapacity() {
            const length = parseFloat(document.getElementById('cartype-length').value) || 0;
            const width = parseFloat(document.getElementById('cartype-width').value) || 0;
            const height = parseFloat(document.getElementById('cartype-height').value) || 0;
            
            const isTandem = document.getElementById('cartype-is-tandem').value === 'true';
            let trailerCubic = 0;
            
            if (isTandem) {
                const trailerLength = parseFloat(document.getElementById('cartype-trailer-length').value) || 0;
                const trailerWidth = parseFloat(document.getElementById('cartype-trailer-width').value) || 0;
                const trailerHeight = parseFloat(document.getElementById('cartype-trailer-height').value) || 0;
                
                trailerCubic = trailerLength * trailerWidth * trailerHeight;
            }
            
            const mainCubic = length * width * height;
            const totalCubic = mainCubic + trailerCubic;
            
            document.getElementById('cartype-main-cubic').textContent = `${mainCubic.toFixed(2)} m³`;
            document.getElementById('cartype-trailer-cubic').textContent = `${trailerCubic.toFixed(2)} m³`;
            document.getElementById('cartype-total-cubic').textContent = `${totalCubic.toFixed(2)} m³`;
            
            // Show/hide trailer cubic row
            const trailerCubicRow = document.getElementById('trailer-cubic-row');
            if (trailerCubicRow) {
                trailerCubicRow.style.display = isTandem ? 'flex' : 'none';
            }
        }

        function calculateCarTypeWeight() {
            const mainWeight = parseFloat(document.getElementById('cartype-main-weight').value) || 0;
            const isTandem = document.getElementById('cartype-is-tandem').value === 'true';
            let trailerWeight = 0;
            
            if (isTandem) {
                trailerWeight = parseFloat(document.getElementById('cartype-trailer-weight').value) || 0;
            }
            
            const totalWeight = mainWeight + trailerWeight;
            
            // Get the display elements and update them
            const mainWeightDisplay = document.getElementById('cartype-main-weight-display');
            const trailerWeightDisplay = document.getElementById('cartype-trailer-weight-display');
            const totalWeightDisplay = document.getElementById('cartype-total-weight-display');
            
            if (mainWeightDisplay) mainWeightDisplay.textContent = `${mainWeight.toFixed(1)} tons`;
            if (trailerWeightDisplay) trailerWeightDisplay.textContent = `${trailerWeight.toFixed(1)} tons`;
            if (totalWeightDisplay) totalWeightDisplay.textContent = `${totalWeight.toFixed(1)} tons`;
            
            // Show/hide trailer weight row
            const trailerWeightRow = document.getElementById('trailer-weight-row');
            if (trailerWeightRow) {
                trailerWeightRow.style.display = isTandem ? 'flex' : 'none';
            }
        }

        function updateCarTypeDetails(carTypeId) {
            const carTypeDetails = document.getElementById('car-type-details');
            const trailerWeightRow = document.getElementById('trailer-weight-row');
            
            if (!carTypeId || carTypeId === '') {
                carTypeDetails.classList.add('hidden');
                if (trailerWeightRow) trailerWeightRow.style.display = 'none';
                return;
            }
            
            const carType = getCarTypeById(carTypeId);
            if (!carType) {
                carTypeDetails.classList.add('hidden');
                if (trailerWeightRow) trailerWeightRow.style.display = 'none';
                return;
            }
            
            // Update dimensions
            document.getElementById('car-type-dimensions').textContent = 
                `${carType.mainDimensions.length}m x ${carType.mainDimensions.width}m x ${carType.mainDimensions.height}m`;
            
            // Update weights
            document.getElementById('car-main-weight').textContent = `${carType.mainMaxWeight.toFixed(1)} tons`;
            
            if (carType.isTandem) {
                if (trailerWeightRow) trailerWeightRow.style.display = 'flex';
                document.getElementById('car-trailer-weight').textContent = `${carType.trailerMaxWeight.toFixed(1)} tons`;
            } else {
                if (trailerWeightRow) trailerWeightRow.style.display = 'none';
            }
            
            document.getElementById('car-total-weight').textContent = 
                `${(carType.mainMaxWeight + (carType.isTandem ? carType.trailerMaxWeight : 0)).toFixed(1)} tons`;
            
            carTypeDetails.classList.remove('hidden');
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const diff = now - past;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return days + ' days ago';
            } else if (hours > 0) {
                return hours + ' hours ago';
            } else if (minutes > 0) {
                return minutes + ' minutes ago';
            } else {
                return seconds + ' seconds ago';
            }
        }

        // Chat functions
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const { data: chat, sha } = await readFile(FILE_PATHS.CHAT) || { data: [], sha: null };
                const now = new Date().toISOString();
                
                const newMessage = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    message: message,
                    timestamp: now
                };
                
                const updatedChat = [...chat, newMessage];
                
                const result = await updateFile(
                    FILE_PATHS.CHAT,
                    'New chat message',
                    utf8ToBase64(JSON.stringify(updatedChat, null, 2)),
                    sha
                );
                
                // Update local state with new SHA
                state.chat = { 
                    data: updatedChat, 
                    sha: result.content.sha 
                };
                renderChatMessages();
                input.value = '';
            } catch (error) {
                addNotification('Failed to send message: ' + error.message, 'error');
                console.error('Send message error:', error);
            }
        }

        function renderChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = '';
            
            if (!state.chat.data || state.chat.data.length === 0) {
                const div = document.createElement('div');
                div.className = 'message other';
                div.innerHTML = `
                    <div class="message-content">No messages yet</div>
                    <div class="message-meta">System - just now</div>
                `;
                messagesContainer.appendChild(div);
                return;
            }
            
            state.chat.data.forEach(msg => {
                const user = state.users.data.find(u => u.id === msg.userId);
                const isOwn = msg.userId === state.currentUser.id;
                
                const div = document.createElement('div');
                div.className = `message ${isOwn ? 'own' : 'other'}`;
                
                const timeAgo = getTimeAgo(msg.timestamp);
                
                div.innerHTML = `
                    <div class="message-content">${msg.message}</div>
                    <div class="message-meta">${user ? `${user.name} ${user.lastname}` : 'Unknown'} - ${timeAgo}</div>
                `;
                
                messagesContainer.appendChild(div);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Notification functions
        function addNotification(message, type = 'info') {
            const notification = {
                id: generateId(),
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            state.notifications.unshift(notification);
            state.unreadNotifications++;
            
            updateNotificationUI();
            showTemporaryNotification(message, type);
        }

        function updateNotificationUI() {
            const countEl = document.getElementById('notification-count');
            if (countEl) {
                countEl.textContent = state.unreadNotifications;
            }
            
            const panel = document.getElementById('notification-panel');
            if (!panel) return;
            
            if (state.notifications.length === 0) {
                panel.innerHTML = '<div class="notification-item">No notifications</div>';
            } else {
                panel.innerHTML = '';
                state.notifications.forEach(notif => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${!notif.read ? 'unread' : ''}`;
                    
                    const typeClass = {
                        'success': 'text-success',
                        'error': 'text-danger',
                        'warning': 'text-warning',
                        'info': 'text-info'
                    }[notif.type] || '';
                    
                    item.innerHTML = `
                        <div class="notification-title ${typeClass}">${notif.message}</div>
                        <div class="notification-time">${getTimeAgo(notif.timestamp)}</div>
                    `;
                    
                    panel.appendChild(item);
                });
            }
        }

        function showTemporaryNotification(message, type) {
            // Create temporary notification element
            const tempNotification = document.createElement('div');
            tempNotification.style.position = 'fixed';
            tempNotification.style.top = '20px';
            tempNotification.style.right = '20px';
            tempNotification.style.backgroundColor = type === 'error' ? '#e74c3c' : 
                                                 type === 'success' ? '#2ecc71' : '#3498db';
            tempNotification.style.color = 'white';
            tempNotification.style.padding = '15px 20px';
            tempNotification.style.borderRadius = '5px';
            tempNotification.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
            tempNotification.style.zIndex = '3000';
            tempNotification.style.transition = 'opacity 0.3s';
            tempNotification.textContent = message;
            
            document.body.appendChild(tempNotification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                tempNotification.style.opacity = '0';
                setTimeout(() => {
                    if (tempNotification.parentNode) {
                        document.body.removeChild(tempNotification);
                    }
                }, 300);
            }, 3000);
        }

        // UI functions
        function showRegister(e) {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showLogin(e) {
            e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function showApp() {
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app');
            
            if (authContainer) authContainer.classList.add('hidden');
            if (appContainer) appContainer.classList.remove('hidden');
            
            // Update user info
            if (state.currentUser) {
                const userName = document.getElementById('user-name');
                const userAvatar = document.getElementById('user-avatar');
                
                if (userName) {
                    userName.textContent = `${state.currentUser.name} ${state.currentUser.lastname}`;
                }
                
                if (userAvatar) {
                    userAvatar.textContent = state.currentUser.name.charAt(0) + state.currentUser.lastname.charAt(0);
                }
                
                // Show admin menu if user is admin
                const adminMenu = document.getElementById('admin-menu');
                if (adminMenu && state.currentUser.status === 'admin') {
                    adminMenu.style.display = 'flex';
                }
                
                // Navigate to dashboard
                navigateTo('dashboard');
            } else {
                addNotification('User information is missing', 'error');
                console.error('state.currentUser is null or undefined in showApp()');
            }
        }

        function handleLogout() {
            localStorage.removeItem('transforward_user');
            state.currentUser = null;
            state.githubToken = '';
            state.repoName = '';
            
            const appContainer = document.getElementById('app');
            const authContainer = document.getElementById('auth-container');
            
            if (appContainer) appContainer.classList.add('hidden');
            if (authContainer) authContainer.classList.remove('hidden');
            
            // Reset forms
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const loginToken = document.getElementById('login-token');
            const loginRepo = document.getElementById('login-repo');
            
            if (loginEmail) loginEmail.value = '';
            if (loginPassword) loginPassword.value = '';
            if (loginToken) loginToken.value = '';
            if (loginRepo) loginRepo.value = '';
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            if (panel) {
                panel.classList.toggle('show');
                
                // Mark all notifications as read
                if (state.unreadNotifications > 0) {
                    state.unreadNotifications = 0;
                    updateNotificationUI();
                }
            }
        }

        function activateTab(tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to clicked tab
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab content
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
        }

        // Navigation
        function navigateTo(view) {
            state.currentView = view;
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-view') === view) {
                    item.classList.add('active');
                }
            });
            
            // Hide all views
            document.querySelectorAll('#app > .main-content > div[id$="-view"]').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show current view
            const currentView = document.getElementById(`${view}-view`);
            if (currentView) {
                currentView.classList.remove('hidden');
                
                // Update page title
                const pageTitle = document.getElementById('page-title');
                if (pageTitle) {
                    pageTitle.textContent = view.charAt(0).toUpperCase() + view.slice(1);
                }
            }
                
            // Special handling for admin view
            if (view === 'admin') {
                if (state.currentUser && state.currentUser.status !== 'admin') {
                    addNotification('Access denied', 'error');
                    navigateTo('dashboard');
                    return;
                }
            }
            
            // Load data for the view
            loadDataForView(view);
        }

        function loadDataForView(view) {
            switch (view) {
                case 'drivers':
                    renderDrivers();
                    break;
                case 'cars':
                    renderCars();
                    break;
                case 'cards':
                    renderCards();
                    break;
                case 'tenders':
                    renderTenders();
                    break;
                case 'invoices':
                    renderInvoices();
                    break;
                case 'reports':
                    renderReports();
                    break;
                case 'admin':
                    renderAdmin();
                    break;
                case 'chat':
                    renderChat();
                    break;
                default:
                    renderDashboard();
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('show');
                }
            });
            
            // Close dropdowns when clicking outside
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown && !event.target.closest('.user-info') && !event.target.closest('.dropdown-menu')) {
                userDropdown.classList.remove('show');
            }
            
            const notificationPanel = document.getElementById('notification-panel');
            if (notificationPanel && !event.target.closest('.notification-icon') && !event.target.closest('.notification-panel')) {
                notificationPanel.classList.remove('show');
            }
        });

        // Close modals with escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                
                const userDropdown = document.getElementById('user-dropdown');
                if (userDropdown) {
                    userDropdown.classList.remove('show');
                }
                
                const notificationPanel = document.getElementById('notification-panel');
                if (notificationPanel) {
                    notificationPanel.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>
